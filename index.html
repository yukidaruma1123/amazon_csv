<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazonå‡ºè·é€šçŸ¥å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-900 mb-8">
            Amazonå‡ºè·é€šçŸ¥å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ï¼ˆä¿®æ­£ç‰ˆï¼‰
        </h1>

        <!-- ä¿®æ­£ç‚¹ã®èª¬æ˜ -->
        <div class="bg-blue-50 p-6 rounded-lg border border-blue-200 mb-6">
            <h3 class="text-lg font-semibold text-blue-800 mb-2">ğŸ”§ ä¿®æ­£å†…å®¹</h3>
            <ul class="text-sm text-blue-700 space-y-1">
                <li>â€¢ <strong>carrier-code</strong>: åŸºæœ¬çš„ã«ã€ŒYAMATOã€ã€ãã®ä»–ã®å ´åˆã®ã¿ã€ŒOtherã€</li>
                <li>â€¢ <strong>carrier-name</strong>: carrier-codeãŒã€ŒOtherã€ä»¥å¤–ã¯ç©ºæ¬„</li>
                <li>â€¢ <strong>ship-method</strong>: åŸºæœ¬çš„ã«ã€ŒNEKOPOSUã€</li>
                <li>â€¢ å…¨ã¦è‹±æ•°å­—ã®ã¿ã§å‡ºåŠ›ã—ã¦Amazonã®è¦ä»¶ã«é©åˆ</li>
            </ul>
        </div>

        <div class="space-y-6">
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4">ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
                        </label>
                        <input
                            type="file"
                            id="txt-upload"
                            class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            è¿½è·¡ç•ªå·ãƒ•ã‚¡ã‚¤ãƒ«
                        </label>
                        <input
                            type="file"
                            id="csv-upload"
                            accept=".csv"
                            class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none"
                        />
                    </div>
                </div>
            </div>

            <!-- å‡¦ç†ãƒœã‚¿ãƒ³ -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4">ãƒ‡ãƒ¼ã‚¿å‡¦ç†</h2>
                
                <div class="flex space-x-4">
                    <button
                        id="process-btn"
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled
                    >
                        ãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Ÿè¡Œ
                    </button>
                    
                    <button
                        id="download-btn"
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled
                    >
                        ä¿®æ­£ç‰ˆTXTãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
            </div>

            <!-- å‡¦ç†çµæœ -->
            <div id="result-section" class="bg-white p-6 rounded-lg shadow" style="display: none;">
                <h2 class="text-lg font-semibold mb-4">å‡¦ç†çµæœ</h2>
                <div id="result-content"></div>
            </div>

            <!-- æ³¨æ„äº‹é … -->
            <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">ä¿®æ­£ç‰ˆã®ç‰¹å¾´</h3>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>â€¢ <strong>carrier-code</strong>: åŸºæœ¬çš„ã«ã€ŒYAMATOã€</li>
                    <li>â€¢ <strong>carrier-name</strong>: ã€ŒOtherã€ä»¥å¤–ã¯ç©ºæ¬„ã€ã€ŒOtherã€ã®å ´åˆã¯è‹±æ•°å­—ã®é…é€æ¥­è€…å</li>
                    <li>â€¢ <strong>ship-method</strong>: åŸºæœ¬çš„ã«ã€ŒNEKOPOSUã€</li>
                    <li>â€¢ å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè‹±æ•°å­—ã®ã¿ã§Amazonã®è¦ä»¶ã«æº–æ‹ </li>
                    <li>â€¢ æ–‡å­—ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°å•é¡Œã‚’å›é¿</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let amazonOrderData = [];
        let trackingData = [];
        let processedData = [];

        // é…é€æ¥­è€…ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆä¿®æ­£ç‰ˆï¼‰
        const carrierMapping = {
            'ãƒ¤ãƒãƒˆé‹è¼¸': { code: 'YAMATO', name: '', method: 'NEKOPOSU' },
            'YAMATO': { code: 'YAMATO', name: '', method: 'NEKOPOSU' },
            'ä½å·æ€¥ä¾¿': { code: 'Other', name: 'SAGAWA', method: 'SAGAWA' },
            'SAGAWA': { code: 'Other', name: 'SAGAWA', method: 'SAGAWA' },
            'æ—¥æœ¬éƒµä¾¿': { code: 'Other', name: 'Japan Post', method: 'Japan Post' },
            'Japan Post': { code: 'Other', name: 'Japan Post', method: 'Japan Post' },
            'ãã®ä»–': { code: 'Other', name: 'Custom Carrier', method: 'Custom' },
            'default': { code: 'YAMATO', name: '', method: 'NEKOPOSU' }
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ä¿®æ­£ç‰ˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–é–‹å§‹');
            
            const txtUpload = document.getElementById('txt-upload');
            const csvUpload = document.getElementById('csv-upload');
            const processBtn = document.getElementById('process-btn');
            const downloadBtn = document.getElementById('download-btn');
            
            if (txtUpload) txtUpload.addEventListener('change', handleTxtUpload);
            if (csvUpload) csvUpload.addEventListener('change', handleCsvUpload);
            if (processBtn) processBtn.addEventListener('click', processData);
            if (downloadBtn) downloadBtn.addEventListener('click', downloadTxt);
            
            console.log('ä¿®æ­£ç‰ˆã‚·ã‚¹ãƒ†ãƒ åˆæœŸåŒ–å®Œäº†');
        });

        // Amazonæ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        async function handleTxtUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const fileContent = await file.text();
                const result = Papa.parse(fileContent, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: '\t',
                    encoding: 'UTF-8'
                });
                
                amazonOrderData = result.data;
                console.log('æ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', amazonOrderData.length, 'ä»¶');
                
                checkProcessButtonState();
            } catch (error) {
                console.error('TXTèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('æ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // è¿½è·¡ç•ªå·ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        async function handleCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const decoder = new TextDecoder('shift_jis');
                const fileContent = decoder.decode(arrayBuffer);
                
                const result = Papa.parse(fileContent, {
                    header: false,
                    skipEmptyLines: true,
                    delimiter: ',',
                    encoding: 'shift_jis'
                });
                
                trackingData = result.data;
                console.log('è¿½è·¡ç•ªå·ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', trackingData.length, 'ä»¶');
                
                checkProcessButtonState();
            } catch (error) {
                console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('è¿½è·¡ç•ªå·ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // å‡¦ç†ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        function checkProcessButtonState() {
            const processBtn = document.getElementById('process-btn');
            const hasOrderData = amazonOrderData.length > 0;
            const hasTrackingData = trackingData.length > 0;
            
            processBtn.disabled = !(hasOrderData && hasTrackingData);
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦å‡ºè·é€šçŸ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆï¼ˆä¿®æ­£ç‰ˆï¼‰
        function processData() {
            if (amazonOrderData.length === 0 || trackingData.length === 0) {
                alert('ä¸¡æ–¹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }

            // è¿½è·¡ç•ªå·ãƒãƒƒãƒ—ã‚’ä½œæˆ
            const trackingMap = buildTrackingMap();
            
            let unmatchedCount = 0;
            const processed = amazonOrderData.map(order => {
                const matchResult = findTrackingNumber(order, trackingMap);
                
                if (!matchResult) {
                    unmatchedCount++;
                }

                // é…é€æ¥­è€…æƒ…å ±ã‚’å–å¾—ï¼ˆä¿®æ­£ç‰ˆï¼‰
                const carrierInfo = getCarrierInfo(order['ssa-carrier']);

                return {
                    'order-id': order['order-id'] || '',
                    'order-item-id': order['order-item-id'] || '',
                    'quantity': order['quantity-purchased'] || '',
                    'ship-date': formatShipDate(new Date().toISOString().split('T')[0]),
                    'carrier-code': carrierInfo.code,
                    'carrier-name': carrierInfo.name, // æ¨™æº–æ¥­è€…ã®å ´åˆã¯ç©ºæ¬„
                    'tracking-number': matchResult ? matchResult.trackingNumber : '',
                    'ship-method': carrierInfo.method, // è‹±èªã®é…é€æ¥­è€…å
                    'cod-collection-method': '',
                    'transparency_code': '',
                    'ship_from_address_name': '',
                    'ship_from_address_line1': '',
                    'ship_from_address_line2': '',
                    'ship_from_address_line3': '',
                    'ship_from_address_city': '',
                    'ship_from_address_county': '',
                    'ship_from_address_state_or_region': '',
                    'ship_from_address_postalcode': '',
                    'ship_from_address_countrycode': ''
                };
            });

            processedData = processed;
            
            // å‡¦ç†çµæœã‚’è¡¨ç¤º
            displayResult(processed, unmatchedCount);
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('download-btn').disabled = false;
            
            console.log('ãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Œäº†:', processed.length, 'ä»¶');
        }

        // ä¿®æ­£ç‰ˆï¼šé…é€æ¥­è€…æƒ…å ±ã‚’å–å¾—
        function getCarrierInfo(carrierInput) {
            // åŸºæœ¬çš„ã«YAMATO + NEKOPOSUã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¨ã™ã‚‹
            if (!carrierInput) {
                return carrierMapping['default'];
            }
            
            // æ—¢çŸ¥ã®é…é€æ¥­è€…ã‚’ãƒã‚§ãƒƒã‚¯
            for (const [key, info] of Object.entries(carrierMapping)) {
                if (key === 'default') continue;
                
                if (carrierInput.includes(key) || 
                    carrierInput.toUpperCase().includes(key.toUpperCase())) {
                    return info;
                }
            }
            
            // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼ˆYAMATO + NEKOPOSUï¼‰
            return carrierMapping['default'];
        }

        // è¿½è·¡ç•ªå·ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰
        function buildTrackingMap() {
            const phoneMap = {};
            const nameAddressMap = {};
            
            // Amazonã®æ³¨æ–‡ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆYåˆ—ã‚’ç¢ºèªï¼‰
            const amazonTrackingData = trackingData.filter(row => {
                const orderSource = row[24] || '';
                return orderSource.includes('JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥ (Amazonåº—)');
            });
            
            amazonTrackingData.forEach(row => {
                const trackingNumber = row[3];
                const phone = row[8];
                const address1 = row[11] || '';
                const address2 = row[12] || '';
                const name = row[15] || '';
                
                // é›»è©±ç•ªå·ãƒãƒƒãƒ—
                if (phone && phone !== '0' && trackingNumber) {
                    const normalizedPhone = normalizePhone(phone);
                    if (normalizedPhone) {
                        phoneMap[normalizedPhone] = trackingNumber;
                    }
                }
                
                // åå‰+ä½æ‰€ãƒãƒƒãƒ—
                if (name && (address1 || address2) && trackingNumber) {
                    const fullAddress = normalizeAddress(address1 + address2);
                    const nameAddressKey = `${name.trim()}|${fullAddress}`;
                    nameAddressMap[nameAddressKey] = trackingNumber;
                }
            });
            
            return { phoneMap, nameAddressMap };
        }

        // è¿½è·¡ç•ªå·ã‚’æ¤œç´¢
        function findTrackingNumber(order, trackingMap) {
            // é›»è©±ç•ªå·ãƒãƒƒãƒãƒ³ã‚°
            const shipPhone = order['buyer-phone-number'];
            const normalizedShipPhone = normalizePhone(shipPhone);
            
            if (normalizedShipPhone && trackingMap.phoneMap[normalizedShipPhone]) {
                return {
                    trackingNumber: trackingMap.phoneMap[normalizedShipPhone],
                    matchType: 'phone'
                };
            }
            
            // åå‰+ä½æ‰€ãƒãƒƒãƒãƒ³ã‚°
            const name = (order['recipient-name'] || '').trim();
            const address = normalizeAddress(
                (order['ship-address-1'] || '') + 
                (order['ship-address-2'] || '') + 
                (order['ship-city'] || '')
            );
            
            if (name && address) {
                const nameAddressKey = `${name}|${address}`;
                if (trackingMap.nameAddressMap[nameAddressKey]) {
                    return {
                        trackingNumber: trackingMap.nameAddressMap[nameAddressKey],
                        matchType: 'name-address'
                    };
                }
            }
            
            return null;
        }

        // é›»è©±ç•ªå·æ­£è¦åŒ–
        function normalizePhone(phone) {
            if (!phone || phone === '0') return null;
            
            let normalized = phone.replace(/[-\s]/g, '');
            
            if (!/^\d+$/.test(normalized)) return null;
            
            if (normalized.length === 9 && !normalized.startsWith('0')) {
                normalized = '0' + normalized;
            }
            
            if (normalized.length === 10 && !normalized.startsWith('0')) {
                normalized = '0' + normalized;
            }
            
            if ((normalized.length === 11 && normalized.startsWith('0')) ||
                (normalized.length === 10 && normalized.startsWith('0'))) {
                return normalized;
            }
            
            return null;
        }

        // ä½æ‰€æ­£è¦åŒ–
        function normalizeAddress(address) {
            return address
                .replace(/\s+/g, '')
                .replace(/[ï¼-ï¼™]/g, (s) => 
                    String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .toLowerCase();
        }

        // å‡ºè·æ—¥ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatShipDate(dateStr) {
            if (!dateStr) return new Date().toISOString().split('T')[0];
            
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            return new Date().toISOString().split('T')[0];
        }

        // å‡¦ç†çµæœã‚’è¡¨ç¤º
        function displayResult(data, unmatchedCount) {
            const resultSection = document.getElementById('result-section');
            const resultContent = document.getElementById('result-content');
            
                html += `
                    <div class="p-4 bg-green-50 border border-green-200 rounded-lg mb-4">
                        <h3 class="font-semibold text-green-800 mb-2">âœ… ä¿®æ­£å®Œäº†</h3>
                        <div class="text-green-700 text-sm">
                            <p>â€¢ carrier-code: åŸºæœ¬çš„ã«ã€ŒYAMATOã€</p>
                            <p>â€¢ carrier-name: ã€ŒOtherã€ä»¥å¤–ã¯ç©ºæ¬„</p>
                            <p>â€¢ ship-method: åŸºæœ¬çš„ã«ã€ŒNEKOPOSUã€</p>
                            <p>â€¢ å…¨ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè‹±æ•°å­—ã®ã¿ã§Amazonè¦ä»¶ã«æº–æ‹ </p>
                        </div>
                    </div>
                `;
            
            if (unmatchedCount > 0) {
                const unmatchedOrders = data.filter(row => !row['tracking-number']);
                
                html += `
                    <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h3 class="font-semibold text-yellow-800 mb-2">âš ï¸ æœªãƒãƒƒãƒæ³¨æ–‡ (${unmatchedCount}ä»¶)</h3>
                        <div class="text-yellow-700 text-sm">
                            <p class="mb-3">ä»¥ä¸‹ã®æ³¨æ–‡ã§è¿½è·¡ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸï¼š</p>
                            <div class="bg-white border rounded p-2 max-h-40 overflow-y-auto">
                `;
                
                unmatchedOrders.slice(0, 10).forEach(order => {
                    html += `
                        <div class="mb-1 text-xs">
                            <strong>æ³¨æ–‡ID:</strong> ${order['order-id']} | 
                            <strong>å•†å“ID:</strong> ${order['order-item-id']}
                        </div>
                    `;
                });
                
                html += `
                            </div>
                        </div>
                    </div>
                `;
            }
            
            resultContent.innerHTML = html;
            resultSection.style.display = 'block';
        }

        // ä¿®æ­£ç‰ˆTXTãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadTxt() {
            if (processedData.length === 0) {
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«å‡¦ç†ã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ä½œæˆ
            const headers = [
                'TemplateType=OrderFulfillment',
                'Version=2011.1102',
                'ã“ã®è¡Œã¯AmazonãŒä½¿ç”¨ã—ã¾ã™ã®ã§å¤‰æ›´ã‚„å‰Šé™¤ã—ãªã„ã§ãã ã•ã„ã€‚'
            ];

            const columnHeaders = [
                'æ³¨æ–‡ç•ªå·', 'æ³¨æ–‡å•†å“ç•ªå·', 'å‡ºè·æ•°', 'å‡ºè·æ—¥', 'é…é€æ¥­è€…ã‚³ãƒ¼ãƒ‰', 'é…é€æ¥­è€…å',
                'ãŠå•ã„åˆã‚ã›ä¼ç¥¨ç•ªå·', 'é…é€æ–¹æ³•', 'ä»£é‡‘å¼•æ›', 'è£½å“ãŒé€æ˜ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã®è£½å“ã®é€æ˜ã‚³ãƒ¼ãƒ‰ã€‚',
                'å‡ºè·å…ƒä½æ‰€-åç§°', 'å‡ºè·å…ƒä½æ‰€-è¡Œ 1', 'å‡ºè·å…ƒä½æ‰€-è¡Œ 2', 'å‡ºè·å…ƒä½æ‰€-è¡Œ 3',
                'å‡ºè·å…ƒä½æ‰€-å¸‚ç”ºæ‘', 'å‡ºè·å…ƒä½æ‰€-éƒ¡', 'å‡ºè·å…ƒä½æ‰€-å·ãƒ»çœ', 'å‡ºè·å…ƒä½æ‰€-éƒµä¾¿ç•ªå·',
                'å‡ºè·å…ƒä½æ‰€-å›½ã‚³ãƒ¼ãƒ‰'
            ];

            const columnIds = [
                'order-id', 'order-item-id', 'quantity', 'ship-date', 'carrier-code', 'carrier-name',
                'tracking-number', 'ship-method', 'cod-collection-method', 'transparency_code',
                'ship_from_address_name', 'ship_from_address_line1', 'ship_from_address_line2',
                'ship_from_address_line3', 'ship_from_address_city', 'ship_from_address_county',
                'ship_from_address_state_or_region', 'ship_from_address_postalcode', 'ship_from_address_countrycode'
            ];

            // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ä½œæˆ
            const dataRows = processedData.map(row => 
                columnIds.map(id => row[id] || '').join('\t')
            );

            // å…¨ã¦ã®è¡Œã‚’çµåˆ
            const content = [
                headers.join('\t'),
                columnHeaders.join('\t'),
                columnIds.join('\t'),
                ...dataRows
            ].join('\n');

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shipping_notification_fixed_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            console.log('ä¿®æ­£ç‰ˆãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†');
        }
    </script>
</body>
</html>
