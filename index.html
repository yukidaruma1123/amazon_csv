<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon出荷通知処理システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">
                📦 Amazon出荷通知処理システム
            </h1>

            <!-- ステップ表示 -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div id="step1-indicator" class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-2">1</div>
                        <span class="text-sm font-medium">テンプレート読み込み</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-200 mx-4">
                        <div id="progress1" class="h-1 bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="step2-indicator" class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold mr-2">2</div>
                        <span class="text-sm font-medium">ファイル選択</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-200 mx-4">
                        <div id="progress2" class="h-1 bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="step3-indicator" class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold mr-2">3</div>
                        <span class="text-sm font-medium">データ処理</span>
                    </div>
                </div>
            </div>

            <!-- テンプレートファイル読み込み状況 -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">📋 テンプレートファイル状況</h3>
                <div id="template-status" class="text-blue-700">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>
                        テンプレートファイルを読み込み中...
                    </div>
                </div>
            </div>

            <!-- ファイル選択エリア -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- Amazon注文レポート -->
                <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 transition-colors">
                    <h3 class="font-semibold text-gray-700 mb-2">📊 Amazon注文レポート</h3>
                    <p class="text-sm text-gray-600 mb-3">TSV形式 (.txt)</p>
                    <input type="file" id="amazon-file" accept=".txt" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="amazon-status" class="mt-2 text-sm"></div>
                </div>

                <!-- 追跡番号CSV -->
                <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 transition-colors">
                    <h3 class="font-semibold text-gray-700 mb-2">🚚 追跡番号CSV</h3>
                    <p class="text-sm text-gray-600 mb-3">CSV形式 (.csv)</p>
                    <input type="file" id="tracking-file" accept=".csv" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="tracking-status" class="mt-2 text-sm"></div>
                </div>
            </div>

            <!-- 処理ボタン -->
            <div class="text-center mb-6">
                <button id="process-btn" 
                        class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white font-bold py-3 px-8 rounded-lg transition-colors disabled:cursor-not-allowed"
                        disabled>
                    🔄 データを処理して出荷通知ファイルを生成
                </button>
            </div>

            <!-- 結果表示エリア -->
            <div id="results" class="hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-green-800 mb-2">✅ 処理完了</h3>
                    <div id="results-summary" class="text-green-700"></div>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-2">📈 マッチング詳細</h3>
                    <div id="matching-details" class="text-gray-700 text-sm"></div>
                </div>
            </div>

            <!-- エラー表示エリア -->
            <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-red-800 mb-2">❌ エラー</h3>
                <div id="error-text" class="text-red-700"></div>
            </div>

            <!-- 進行状況表示 -->
            <div id="progress-area" class="hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">⚙️ 処理中...</h3>
                    <div class="w-full bg-blue-200 rounded-full h-2 mb-2">
                        <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="progress-text" class="text-blue-700 text-sm">処理を開始しています...</div>
                </div>
            </div>
        </div>

        <!-- フッター -->
        <div class="text-center mt-8 text-gray-600 text-sm">
            <p>Amazon出荷通知処理システム v1.0.0</p>
            <p>対応配送業者: ヤマト運輸・佐川急便・日本郵便・フェデックス</p>
        </div>
    </div>

    <script>
        // グローバル変数
        let templateData = null;
        let amazonOrders = [];
        let trackingData = [];

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadTemplate();
            setupEventListeners();
        });

        // テンプレートファイルの読み込み
        async function loadTemplate() {
            try {
                const response = await fetch('Flat.File.ShippingConfirmation.jp.xls');
                if (!response.ok) {
                    throw new Error('テンプレートファイルが見つかりません');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // 最初のシートを取得
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // ヘッダー行を取得（テンプレート構造の確認）
                const headers = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0];
                templateData = { workbook, headers };
                
                updateTemplateStatus(true, `✅ テンプレート読み込み完了 (${headers.length}列)`);
                updateStep(1, true);
                
            } catch (error) {
                console.error('テンプレート読み込みエラー:', error);
                updateTemplateStatus(false, `❌ テンプレート読み込み失敗: ${error.message}`);
            }
        }

        // イベントリスナーの設定
        function setupEventListeners() {
            document.getElementById('amazon-file').addEventListener('change', handleAmazonFile);
            document.getElementById('tracking-file').addEventListener('change', handleTrackingFile);
            document.getElementById('process-btn').addEventListener('click', processData);
        }

        // ステップ表示の更新
        function updateStep(step, completed) {
            const indicator = document.getElementById(`step${step}-indicator`);
            const progress = document.getElementById(`progress${step}`);
            
            if (completed) {
                indicator.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold mr-2';
                indicator.innerHTML = '✓';
                if (progress) progress.style.width = '100%';
                
                // 次のステップをアクティブに
                if (step < 3) {
                    const nextIndicator = document.getElementById(`step${step + 1}-indicator`);
                    nextIndicator.className = 'w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-2';
                }
            }
        }

        // テンプレート状況の更新
        function updateTemplateStatus(success, message) {
            const statusElement = document.getElementById('template-status');
            statusElement.innerHTML = message;
            statusElement.className = success ? 'text-green-700' : 'text-red-700';
        }

        // Amazonファイルの処理
        async function handleAmazonFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const content = await readFileAsText(file);
                amazonOrders = parseAmazonReport(content);
                
                const statusElement = document.getElementById('amazon-status');
                statusElement.innerHTML = `✅ ${amazonOrders.length}件の注文を読み込みました`;
                statusElement.className = 'text-green-600';
                
                updateStep(2, amazonOrders.length > 0 && trackingData.length > 0);
                updateProcessButton();
                
            } catch (error) {
                console.error('Amazonファイル読み込みエラー:', error);
                const statusElement = document.getElementById('amazon-status');
                statusElement.innerHTML = `❌ エラー: ${error.message}`;
                statusElement.className = 'text-red-600';
            }
        }

        // 追跡番号ファイルの処理
        async function handleTrackingFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const content = await readFileAsText(file, 'Shift_JIS');
                trackingData = parseTrackingCSV(content);
                
                const statusElement = document.getElementById('tracking-status');
                statusElement.innerHTML = `✅ ${trackingData.length}件の追跡情報を読み込みました`;
                statusElement.className = 'text-green-600';
                
                updateStep(2, amazonOrders.length > 0 && trackingData.length > 0);
                updateProcessButton();
                
            } catch (error) {
                console.error('追跡ファイル読み込みエラー:', error);
                const statusElement = document.getElementById('tracking-status');
                statusElement.innerHTML = `❌ エラー: ${error.message}`;
                statusElement.className = 'text-red-600';
            }
        }

        // ファイル読み込み関数
        function readFileAsText(file, encoding = 'UTF-8') {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('ファイル読み込みに失敗しました'));
                
                if (encoding === 'Shift_JIS') {
                    reader.readAsText(file, 'Shift_JIS');
                } else {
                    reader.readAsText(file, 'UTF-8');
                }
            });
        }

        // 電話番号の正規化
        function normalizePhoneNumber(phone) {
            if (!phone) return '';
            
            // ハイフン、スペース、括弧を除去
            let normalized = phone.replace(/[-\s()]/g, '');
            
            // 先頭が0でない場合は0を追加
            if (normalized && !normalized.startsWith('0') && !normalized.startsWith('+')) {
                normalized = '0' + normalized;
            }
            
            return normalized;
        }

        // Amazon注文レポートの解析
        function parseAmazonReport(content) {
            console.log('Amazon注文レポートを解析中...');
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];

            const headers = lines[0].split('\t');
            console.log('ヘッダー数:', headers.length);
            console.log('主要ヘッダー:', headers.slice(0, 15));

            // 重要なフィールドのインデックスを取得
            const indices = {
                orderId: headers.indexOf('order-id'),
                buyerPhone: headers.indexOf('buyer-phone-number'),
                recipientName: headers.indexOf('recipient-name'),
                shipAddress1: headers.indexOf('ship-address-1'),
                shipAddress2: headers.indexOf('ship-address-2'),
                shipAddress3: headers.indexOf('ship-address-3'),
                shipCity: headers.indexOf('ship-city'),
                shipState: headers.indexOf('ship-state'),
                shipPostalCode: headers.indexOf('ship-postal-code')
            };

            console.log('フィールドインデックス:', indices);

            // 必須フィールドの存在確認
            const missingFields = Object.entries(indices)
                .filter(([key, index]) => index === -1)
                .map(([key]) => key);

            if (missingFields.length > 0) {
                console.warn('見つからないフィールド:', missingFields);
            }

            const orders = [];
            for (let i = 1; i < lines.length; i++) {
                const fields = lines[i].split('\t');
                if (fields.length < Math.max(...Object.values(indices).filter(idx => idx !== -1))) {
                    console.warn(`行${i+1}: フィールド数が不足 (${fields.length})`);
                    continue;
                }

                const order = {
                    orderId: fields[indices.orderId] || '',
                    buyerPhone: normalizePhoneNumber(fields[indices.buyerPhone] || ''),
                    recipientName: (fields[indices.recipientName] || '').trim(),
                    shipAddress1: (fields[indices.shipAddress1] || '').trim(),
                    shipAddress2: (fields[indices.shipAddress2] || '').trim(),
                    shipAddress3: (fields[indices.shipAddress3] || '').trim(),
                    shipCity: (fields[indices.shipCity] || '').trim(),
                    shipState: (fields[indices.shipState] || '').trim(),
                    shipPostalCode: (fields[indices.shipPostalCode] || '').trim()
                };

                // デバッグ用: 最初の5件の詳細を表示
                if (i <= 5) {
                    console.log(`注文${i}:`, {
                        orderId: order.orderId,
                        phone: order.buyerPhone,
                        name: order.recipientName,
                        address: order.shipAddress1
                    });
                }

                // 基本情報があるもののみ追加
                if (order.orderId && (order.buyerPhone || order.recipientName)) {
                    orders.push(order);
                }
            }

            console.log(`${orders.length}件の注文を解析しました`);
            return orders;
        }

        // 追跡番号CSVの解析
        function parseTrackingCSV(content) {
            console.log('追跡番号CSVを解析中...');
            
            const result = Papa.parse(content, {
                dynamicTyping: true,
                skipEmptyLines: true,
                delimitersToGuess: [',', '\t', '|', ';']
            });

            if (result.errors.length > 0) {
                console.warn('CSV解析警告:', result.errors);
            }

            const data = result.data;
            if (data.length === 0) return [];

            console.log('CSV解析結果:', data.slice(0, 3));

            const trackingList = [];
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length < 16) continue;

                const tracking = {
                    trackingNumber: String(row[3] || '').trim(), // D列
                    phone: normalizePhoneNumber(String(row[8] || '')), // I列
                    address1: String(row[11] || '').trim(), // L列
                    address2: String(row[12] || '').trim(), // M列
                    name: String(row[15] || '').trim() // P列
                };

                // デバッグ用: 最初の5件の詳細を表示
                if (i < 5) {
                    console.log(`追跡${i+1}:`, tracking);
                }

                // 追跡番号があるもののみ追加
                if (tracking.trackingNumber) {
                    trackingList.push(tracking);
                }
            }

            console.log(`${trackingList.length}件の追跡情報を解析しました`);
            return trackingList;
        }

        // 文字列類似度計算（Jaro-Winkler距離の簡易版）
        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            if (str1 === str2) return 1;

            const len1 = str1.length;
            const len2 = str2.length;
            const maxDistance = Math.floor(Math.max(len1, len2) / 2) - 1;

            let matches = 0;
            const str1Matches = new Array(len1).fill(false);
            const str2Matches = new Array(len2).fill(false);

            // マッチする文字を見つける
            for (let i = 0; i < len1; i++) {
                const start = Math.max(0, i - maxDistance);
                const end = Math.min(i + maxDistance + 1, len2);

                for (let j = start; j < end; j++) {
                    if (str2Matches[j] || str1[i] !== str2[j]) continue;
                    str1Matches[i] = true;
                    str2Matches[j] = true;
                    matches++;
                    break;
                }
            }

            if (matches === 0) return 0;

            // 転置の計算
            let transpositions = 0;
            let k = 0;
            for (let i = 0; i < len1; i++) {
                if (!str1Matches[i]) continue;
                while (!str2Matches[k]) k++;
                if (str1[i] !== str2[k]) transpositions++;
                k++;
            }

            const jaro = (matches / len1 + matches / len2 + (matches - transpositions / 2) / matches) / 3;
            return jaro;
        }

        // 配送業者コードの決定（追跡番号形式の厳密チェック）
        function getCarrierCode(trackingNumber) {
            if (!trackingNumber) return 'YAMATO';

            const tracking = trackingNumber.toString().replace(/[-\s]/g, '');
            
            // ヤマト運輸: 12桁の数字（例：767076335325）
            if (/^\d{12}$/.test(tracking)) {
                return 'YAMATO';
            }
            
            // 佐川急便: 10-12桁の数字
            if (/^\d{10,12}$/.test(tracking) && !tracking.startsWith('7670')) {
                return 'SAGAWA';
            }
            
            // 日本郵便: アルファベット2文字+数字9桁+アルファベット2文字
            if (/^[A-Z]{2}\d{9}[A-Z]{2}$/.test(tracking)) {
                return 'Japan Post';
            }
            
            // フェデックス: 14桁または20桁の数字
            if (/^\d{14}$/.test(tracking) || /^\d{20}$/.test(tracking)) {
                return 'FEDEX';
            }

            // 数字のみで11桁の場合もヤマト運輸の可能性
            if (/^\d{11}$/.test(tracking)) {
                return 'YAMATO';
            }

            // デフォルトはヤマト運輸
            return 'YAMATO';
        }

        // データマッチング処理
        function matchData() {
            console.log('データマッチングを開始...');
            
            const matches = {
                phoneExact: 0,
                phoneNormalized: 0,
                nameAddress: 0,
                fuzzy: 0,
                unmatched: 0
            };

            const matchedOrders = [];

            for (const order of amazonOrders) {
                let bestMatch = null;
                let matchType = 'unmatched';

                // 1. 電話番号での完全一致
                if (order.buyerPhone) {
                    bestMatch = trackingData.find(track => 
                        track.phone && track.phone === order.buyerPhone
                    );
                    if (bestMatch) {
                        matchType = 'phoneExact';
                        matches.phoneExact++;
                    }
                }

                // 2. 電話番号の正規化一致
                if (!bestMatch && order.buyerPhone) {
                    const normalizedOrderPhone = normalizePhoneNumber(order.buyerPhone);
                    bestMatch = trackingData.find(track => {
                        const normalizedTrackPhone = normalizePhoneNumber(track.phone);
                        return normalizedTrackPhone && normalizedTrackPhone === normalizedOrderPhone;
                    });
                    if (bestMatch) {
                        matchType = 'phoneNormalized';
                        matches.phoneNormalized++;
                    }
                }

                // 3. 名前＋住所での一致
                if (!bestMatch && order.recipientName && order.shipAddress1) {
                    bestMatch = trackingData.find(track => 
                        track.name && track.address1 &&
                        track.name.includes(order.recipientName.replace(/\s/g, '')) &&
                        track.address1.includes(order.shipAddress1.replace(/\s/g, ''))
                    );
                    if (bestMatch) {
                        matchType = 'nameAddress';
                        matches.nameAddress++;
                    }
                }

                // 4. あいまいマッチング（類似度80%以上）
                if (!bestMatch && order.recipientName) {
                    let maxSimilarity = 0;
                    let fuzzyMatch = null;

                    for (const track of trackingData) {
                        if (!track.name) continue;
                        
                        const similarity = calculateSimilarity(
                            order.recipientName.replace(/\s/g, ''),
                            track.name.replace(/\s/g, '')
                        );

                        if (similarity > maxSimilarity && similarity >= 0.8) {
                            maxSimilarity = similarity;
                            fuzzyMatch = track;
                        }
                    }

                    if (fuzzyMatch) {
                        bestMatch = fuzzyMatch;
                        matchType = 'fuzzy';
                        matches.fuzzy++;
                    }
                }

                // マッチしなかった場合
                if (!bestMatch) {
                    matches.unmatched++;
                }

                // 結果を記録
                matchedOrders.push({
                    order,
                    tracking: bestMatch,
                    matchType,
                    carrierCode: bestMatch ? getCarrierCode(bestMatch.trackingNumber) : 'YAMATO'
                });
            }

            console.log('マッチング結果:', matches);
            return { matchedOrders, matches };
        }

        // 出荷通知ファイルの生成
        function generateShippingFile(matchedOrders) {
            console.log('出荷通知ファイルを生成中...');

            const headers = [
                'order-id', 'order-item-id', 'quantity', 'ship-date', 'carrier-code', 'carrier-name',
                'tracking-number', 'ship-method'
            ];

            const rows = [headers];
            
            // 重複追跡番号の処理
            const duplicateTrackingInfo = processDuplicateTrackingNumbers(matchedOrders);

            for (const match of matchedOrders) {
                if (!match.tracking) continue; // マッチしなかったものはスキップ

                const today = new Date().toISOString().split('T')[0];
                
                // 重複追跡番号の場合、最初の注文のみに追跡番号を設定
                let trackingNumber = match.tracking.trackingNumber;
                if (duplicateTrackingInfo.duplicates[trackingNumber]) {
                    // この注文IDが最初の注文でない場合は追跡番号を空にする
                    if (duplicateTrackingInfo.duplicates[trackingNumber].firstOrderId !== match.order.orderId) {
                        trackingNumber = '';
                    }
                }
                
                rows.push([
                    match.order.orderId,
                    '', // order-item-id は空
                    '1', // quantity
                    today,
                    match.carrierCode,
                    getCarrierName(match.carrierCode),
                    trackingNumber,
                    'Standard' // ship-method を明示的に設定
                ]);
            }

            // TSV形式で出力（UTF-8 BOM付き）
            const tsvContent = '\ufeff' + rows.map(row => row.join('\t')).join('\r\n');
            
            // ファイルダウンロード（UTF-8 BOM付き）
            const blob = new Blob([tsvContent], { 
                type: 'text/plain;charset=utf-8-sig' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shipping_notification_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            return { 
                totalRows: rows.length - 1, // ヘッダーを除いた件数
                duplicateInfo: duplicateTrackingInfo 
            };
        }

        // 重複追跡番号の処理
        function processDuplicateTrackingNumbers(matchedOrders) {
            const trackingCounts = {};
            const duplicates = {};
            
            // 追跡番号の出現回数をカウント
            for (const match of matchedOrders) {
                if (!match.tracking || !match.tracking.trackingNumber) continue;
                
                const trackingNumber = match.tracking.trackingNumber;
                if (!trackingCounts[trackingNumber]) {
                    trackingCounts[trackingNumber] = {
                        count: 0,
                        orders: []
                    };
                }
                trackingCounts[trackingNumber].count++;
                trackingCounts[trackingNumber].orders.push(match);
            }
            
            // 重複している追跡番号を特定
            let duplicateTrackingCount = 0;
            let duplicateOrderCount = 0;
            
            for (const [trackingNumber, info] of Object.entries(trackingCounts)) {
                if (info.count > 1) {
                    duplicateTrackingCount++;
                    duplicateOrderCount += info.count;
                    
                    // 最初の注文を特定（注文IDでソート）
                    info.orders.sort((a, b) => a.order.orderId.localeCompare(b.order.orderId));
                    
                    duplicates[trackingNumber] = {
                        count: info.count,
                        firstOrderId: info.orders[0].order.orderId,
                        allOrderIds: info.orders.map(match => match.order.orderId),
                        customerInfo: {
                            name: info.orders[0].order.recipientName,
                            phone: info.orders[0].order.buyerPhone,
                            address: info.orders[0].order.shipAddress1
                        }
                    };
                }
            }
            
            console.log(`重複追跡番号処理完了: ${duplicateTrackingCount}件の追跡番号が重複 (${duplicateOrderCount}注文)`);
            
            return {
                duplicates,
                duplicateTrackingCount,
                duplicateOrderCount
            };
        }

        // 配送業者名の取得
        function getCarrierName(carrierCode) {
            const carriers = {
                'YAMATO': 'ヤマト運輸',
                'SAGAWA': '佐川急便',
                'Japan Post': '日本郵便',
                'FEDEX': 'フェデックス'
            };
            return carriers[carrierCode] || 'ヤマト運輸';
        }

        // 処理ボタンの状態更新
        function updateProcessButton() {
            const button = document.getElementById('process-btn');
            const canProcess = templateData && amazonOrders.length > 0 && trackingData.length > 0;
            
            button.disabled = !canProcess;
            if (canProcess) {
                button.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition-colors';
            } else {
                button.className = 'bg-gray-400 text-white font-bold py-3 px-8 rounded-lg cursor-not-allowed';
            }
        }

        // 進行状況の更新
        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar) progressBar.style.width = `${percent}%`;
            if (progressText) progressText.textContent = message;
        }

        // エラー表示
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // 5秒後に自動的に隠す
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // 結果表示
        function showResults(result, totalCount, matches) {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('results-summary');
            const detailsDiv = document.getElementById('matching-details');

            const duplicateInfo = result.duplicateInfo;
            const duplicateWarning = duplicateInfo.duplicateTrackingCount > 0 ? 
                `<div class="mt-2 p-2 bg-yellow-100 border border-yellow-400 rounded text-yellow-800">
                    <strong>⚠️ 重複追跡番号対応:</strong> ${duplicateInfo.duplicateTrackingCount}件の追跡番号が重複していました。
                    最初の注文のみに追跡番号を設定し、他は空白にしました。
                </div>` : '';

            summaryDiv.innerHTML = `
                <p class="font-semibold">出荷通知ファイルを生成しました</p>
                <p>${result.totalRows}件 / ${totalCount}件 の注文データを出力しました</p>
                ${duplicateWarning}
            `;

            detailsDiv.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-2 bg-green-100 rounded">
                        <div class="font-bold text-green-800">${matches.phoneExact}</div>
                        <div class="text-xs text-green-600">電話番号完全一致</div>
                    </div>
                    <div class="text-center p-2 bg-blue-100 rounded">
                        <div class="font-bold text-blue-800">${matches.phoneNormalized}</div>
                        <div class="text-xs text-blue-600">電話番号正規化一致</div>
                    </div>
                    <div class="text-center p-2 bg-yellow-100 rounded">
                        <div class="font-bold text-yellow-800">${matches.nameAddress}</div>
                        <div class="text-xs text-yellow-600">名前+住所一致</div>
                    </div>
                    <div class="text-center p-2 bg-purple-100 rounded">
                        <div class="font-bold text-purple-800">${matches.fuzzy}</div>
                        <div class="text-xs text-purple-600">あいまい一致</div>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <span class="text-red-600 font-medium">未マッチ: ${matches.unmatched}件</span>
                </div>
            `;

            resultsDiv.classList.remove('hidden');
        }

        // メインの処理関数
        async function processData() {
            try {
                // UI更新
                const progressArea = document.getElementById('progress-area');
                const resultsDiv = document.getElementById('results');
                const errorDiv = document.getElementById('error-message');
                
                progressArea.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');

                // 処理開始
                updateProgress(10, 'データマッチングを開始しています...');
                
                // データマッチング
                await new Promise(resolve => setTimeout(resolve, 500)); // UI更新のための短い遅延
                const { matchedOrders, matches } = matchData();
                
                updateProgress(60, 'マッチング完了。出荷通知ファイルを生成中...');
                
                // 出荷通知ファイル生成
                await new Promise(resolve => setTimeout(resolve, 500));
                const result = generateShippingFile(matchedOrders);
                
                updateProgress(100, '処理完了');
                
                // 結果表示
                setTimeout(() => {
                    progressArea.classList.add('hidden');
                    showResults(result, amazonOrders.length, matches);
                    updateStep(3, true);
                }, 1000);
                
            } catch (error) {
                console.error('処理エラー:', error);
                document.getElementById('progress-area').classList.add('hidden');
                showError(`処理中にエラーが発生しました: ${error.message}`);
            }
        }
    </script>
</body>
</html>
