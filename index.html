<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazonå‡ºè·é€šçŸ¥å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-900 mb-8">
            Amazonå‡ºè·é€šçŸ¥å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 
        </h1>

        <div class="space-y-6">
            <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4">ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            æ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«
                        </label>
                        <input
                            type="file"
                            id="txt-upload"
                            class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            è¿½è·¡ç•ªå·ãƒ•ã‚¡ã‚¤ãƒ«
                        </label>
                        <input
                            type="file"
                            id="csv-upload"
                            accept=".csv"
                            class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none"
                        />
                    </div>
                </div>
            </div>

            <!-- å‡¦ç†ãƒœã‚¿ãƒ³ -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4">ãƒ‡ãƒ¼ã‚¿å‡¦ç†</h2>
                
                <div class="flex space-x-4">
                    <button
                        id="process-btn"
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled
                    >
                        ãƒ‡ãƒ¼ã‚¿å‡¦ç†å®Ÿè¡Œ
                    </button>
                    
                    <button
                        id="download-btn"
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled
                    >
                        TXTãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                    </button>
                </div>
            </div>

            <!-- å‡¦ç†çµæœ -->
            <div id="result-section" class="bg-white p-6 rounded-lg shadow" style="display: none;">
                <h2 class="text-lg font-semibold mb-4">å‡¦ç†çµæœ</h2>
                <div id="result-content"></div>
            </div>

            <!-- æ³¨æ„äº‹é … -->
            <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">æ³¨æ„äº‹é …</h3>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>â€¢ Amazonã‚»ãƒ©ãƒ¼ã‚»ãƒ³ãƒˆãƒ©ãƒ«ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸæ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆTXTãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãã®ã¾ã¾ä½¿ç”¨ã—ã¦ãã ã•ã„</li>
                    <li>â€¢ å‡ºè·æ—¥ãƒ»é…é€æ¥­è€…ãƒ»è¿½è·¡ç•ªå·ã®æƒ…å ±ã‚’æ‰‹å‹•ã§å…¥åŠ›ã™ã‚‹å ´åˆã¯ã€é©åˆ‡ãªå½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„</li>
                    <li>â€¢ ç”Ÿæˆã•ã‚ŒãŸTXTãƒ•ã‚¡ã‚¤ãƒ«ã‚’Amazonã‚»ãƒ©ãƒ¼ã‚»ãƒ³ãƒˆãƒ©ãƒ«ã®ã€Œæ³¨æ–‡é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</li>
                    <li>â€¢ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã¯è‡ªå‹•ã§èª­ã¿è¾¼ã¾ã‚Œã¾ã™</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let amazonOrderData = [];
        let trackingData = [];
        let templateData = [];
        let carrierList = [];
        let processedData = [];
        let templateLoaded = false;

        // ã‚­ãƒ£ãƒªã‚¢ã‚³ãƒ¼ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°
        const carrierCodeMap = {
            'ãƒ¤ãƒãƒˆé‹è¼¸': 'YAMATO',
            'YAMATO': 'YAMATO',
            'æ—¥æœ¬éƒµä¾¿': 'Japan Post',
            'Japan Post': 'Japan Post',
            'ä½å·æ€¥ä¾¿': 'SAGAWA',
            'SAGAWA': 'SAGAWA',
            'ãƒ•ã‚§ãƒ‡ãƒƒã‚¯ã‚¹': 'FEDEX',
            'FEDEX': 'FEDEX'
        };

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - åˆæœŸåŒ–é–‹å§‹');
            
            loadTemplateFile();
            
            const txtUpload = document.getElementById('txt-upload');
            const csvUpload = document.getElementById('csv-upload');
            const processBtn = document.getElementById('process-btn');
            const downloadBtn = document.getElementById('download-btn');
            
            console.log('è¦ç´ ç¢ºèª:', {
                txtUpload: !!txtUpload,
                csvUpload: !!csvUpload,
                processBtn: !!processBtn,
                downloadBtn: !!downloadBtn
            });
            
            if (txtUpload) {
                txtUpload.addEventListener('change', handleTxtUpload);
                console.log('TXTã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
            }
            
            if (csvUpload) {
                csvUpload.addEventListener('change', handleCsvUpload);
                console.log('CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
            }
            
            if (processBtn) {
                processBtn.addEventListener('click', processData);
                console.log('å‡¦ç†ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
            }
            
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadTxt);
                console.log('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆè¨­å®šå®Œäº†');
            }
            
            console.log('åˆæœŸåŒ–å®Œäº†');
        });

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
        async function loadTemplateFile() {
            try {
                const response = await fetch('./Flat.File.ShippingConfirmation.jp.xls');
                if (!response.ok) {
                    console.warn('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const fileContent = await response.arrayBuffer();
                const workbook = XLSX.read(fileContent, { type: 'array' });
                
                // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚·ãƒ¼ãƒˆã®ãƒ˜ãƒƒãƒ€ãƒ¼å–å¾—
                const templateSheet = workbook.Sheets['å‡ºè·é€šçŸ¥ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ_Template'];
                templateData = XLSX.utils.sheet_to_json(templateSheet, { header: 1 });
                
                // é…é€æ¥­è€…ãƒªã‚¹ãƒˆå–å¾—
                const carrierSheet = workbook.Sheets['é…é€æ¥­è€…åæ¨å¥¨å€¤'];
                carrierList = XLSX.utils.sheet_to_json(carrierSheet, { header: 1 });
                
                templateLoaded = true;
                console.log('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«è‡ªå‹•èª­ã¿è¾¼ã¿å®Œäº†');
            } catch (error) {
                console.warn('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®è‡ªå‹•èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error.message);
            }
        }

        // Amazonæ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ï¼ˆä¿®æ­£ç‰ˆï¼‰
        async function handleTxtUpload(event) {
            console.log('TXT upload triggered');
            const file = event.target.files[0];
            console.log('TXT file selected:', file ? file.name : 'none');
            
            if (!file) return;

            try {
                const fileContent = await file.text();
                const result = Papa.parse(fileContent, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: '\t',
                    encoding: 'UTF-8'
                });
                
                amazonOrderData = result.data;
                console.log('æ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', amazonOrderData.length, 'ä»¶');
                console.log('ãƒ‡ãƒ¼ã‚¿ã‚µãƒ³ãƒ—ãƒ«:', amazonOrderData.slice(0, 3));
                
                // ãƒ‡ãƒ¼ã‚¿ã®åˆ—ã‚’ç¢ºèª
                if (amazonOrderData.length > 0) {
                    console.log('åˆ©ç”¨å¯èƒ½ãªåˆ—:', Object.keys(amazonOrderData[0]));
                }
                
                checkProcessButtonState();
            } catch (error) {
                console.error('TXTèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('æ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // è¿½è·¡ç•ªå·ãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€
        async function handleCsvUpload(event) {
            console.log('CSV upload triggered');
            const file = event.target.files[0];
            console.log('CSV file selected:', file ? file.name : 'none');
            
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const decoder = new TextDecoder('shift_jis');
                const fileContent = decoder.decode(arrayBuffer);
                
                const result = Papa.parse(fileContent, {
                    header: false,
                    skipEmptyLines: true,
                    delimiter: ',',
                    encoding: 'shift_jis'
                });
                
                trackingData = result.data;
                console.log('è¿½è·¡ç•ªå·ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº†:', trackingData.length, 'ä»¶');
                
                checkProcessButtonState();
            } catch (error) {
                console.error('CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                alert('è¿½è·¡ç•ªå·ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
            }
        }

        // å‡¦ç†ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
        function checkProcessButtonState() {
            const processBtn = document.getElementById('process-btn');
            const hasOrderData = amazonOrderData.length > 0;
            const hasTrackingData = trackingData.length > 0;
            
            console.log('Check button state:', {
                hasOrderData,
                hasTrackingData,
                orderCount: amazonOrderData.length,
                trackingCount: trackingData.length
            });
            
            processBtn.disabled = !(hasOrderData && hasTrackingData);
            
            if (hasOrderData && hasTrackingData) {
                console.log('ä¸¡ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿å®Œäº† - ãƒœã‚¿ãƒ³æœ‰åŠ¹åŒ–');
            }
        }

        // ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦å‡ºè·é€šçŸ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
        function processData() {
            if (amazonOrderData.length === 0) {
                alert('æ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }

            if (trackingData.length === 0) {
                alert('è¿½è·¡ç•ªå·ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§ãã ã•ã„');
                return;
            }

            // è¿½è·¡ç•ªå·ãƒãƒƒãƒ—ã‚’ä½œæˆ
            const trackingMap = buildTrackingMap();
            
            let unmatchedCount = 0;
            const processed = amazonOrderData.map(order => {
                const matchResult = findTrackingNumber(order, trackingMap);
                
                if (!matchResult) {
                    unmatchedCount++;
                }

                return {
                    'order-id': order['order-id'] || '',
                    'order-item-id': order['order-item-id'] || '',
                    'quantity': order['quantity-purchased'] || '',
                    'ship-date': formatShipDate(new Date().toISOString().split('T')[0]),
                    'carrier-code': getCarrierCode(order['ssa-carrier']),
                    'carrier-name': getCarrierName(order['ssa-carrier']),
                    'tracking-number': matchResult ? matchResult.trackingNumber : '',
                    'ship-method': '',
                    'cod-collection-method': '',
                    'transparency_code': '',
                    'ship_from_address_name': '',
                    'ship_from_address_line1': '',
                    'ship_from_address_line2': '',
                    'ship_from_address_line3': '',
                    'ship_from_address_city': '',
                    'ship_from_address_county': '',
                    'ship_from_address_state_or_region': '',
                    'ship_from_address_postalcode': '',
                    'ship_from_address_countrycode': ''
                };
            });

            processedData = processed;
            
            // å‡¦ç†çµæœã‚’è¡¨ç¤º
            displayResult(processed, unmatchedCount);
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³ã‚’æœ‰åŠ¹åŒ–
            document.getElementById('download-btn').disabled = false;
        }

        // è¿½è·¡ç•ªå·ãƒãƒƒãƒ—ã‚’æ§‹ç¯‰ï¼ˆAmazonãƒ‡ãƒ¼ã‚¿ã®ã¿ï¼‰
        function buildTrackingMap() {
            const phoneMap = {};
            const nameAddressMap = {};
            
            console.log('è¿½è·¡ç•ªå·ãƒãƒƒãƒ—æ§‹ç¯‰é–‹å§‹:', trackingData.length, 'ä»¶');
            
            // Amazonã®æ³¨æ–‡ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const amazonTrackingData = trackingData.filter((row, index) => {
                const orderSource = row[1] || ''; // Båˆ—ï¼šæ³¨æ–‡å…ƒ
                const isAmazon = orderSource.includes('JGSãƒ•ã‚£ãƒƒã‚·ãƒ¥ (Amazonåº—)');
                if (index < 10) {
                    console.log(`è¡Œ ${index + 1}: æ³¨æ–‡å…ƒ="${orderSource}" Amazon=${isAmazon}`);
                }
                return isAmazon;
            });
            
            console.log('Amazonæ³¨æ–‡ãƒ‡ãƒ¼ã‚¿:', amazonTrackingData.length, 'ä»¶');
            
            amazonTrackingData.forEach((row, index) => {
                const trackingNumber = row[3]; // Dåˆ—ï¼šè¿½è·¡ç•ªå·
                const phone = row[8]; // Iåˆ—ï¼šé›»è©±ç•ªå·
                const address1 = row[11] || ''; // Låˆ—ï¼šä½æ‰€1
                const address2 = row[12] || ''; // Måˆ—ï¼šä½æ‰€2
                const name = row[15] || ''; // Påˆ—ï¼šåå‰
                
                if (index < 5) {
                    console.log(`Amazon CSVãƒ‡ãƒ¼ã‚¿ ${index + 1}:`, {
                        trackingNumber,
                        phone: `"${phone}" (${phone ? phone.length : 0}æ¡)`,
                        name: `"${name}"`,
                        address1: `"${address1}"`
                    });
                }
                
                // é›»è©±ç•ªå·ãƒãƒƒãƒ—
                if (phone && phone !== '0' && trackingNumber) {
                    const normalizedPhone = normalizePhone(phone);
                    if (normalizedPhone) {
                        phoneMap[normalizedPhone] = trackingNumber;
                        if (index < 5) {
                            console.log(`  é›»è©±ç•ªå·ãƒãƒƒãƒ—: "${phone}" â†’ "${normalizedPhone}" â†’ ${trackingNumber}`);
                        }
                    } else if (index < 5) {
                        console.log(`  é›»è©±ç•ªå·æ­£è¦åŒ–å¤±æ•—: "${phone}"`);
                    }
                }
                
                // åå‰+ä½æ‰€ãƒãƒƒãƒ—
                if (name && (address1 || address2) && trackingNumber) {
                    const fullAddress = normalizeAddress(address1 + address2);
                    const nameAddressKey = `${name.trim()}|${fullAddress}`;
                    nameAddressMap[nameAddressKey] = trackingNumber;
                    if (index < 3) {
                        console.log(`  åå‰+ä½æ‰€ãƒãƒƒãƒ—: "${nameAddressKey}" â†’ ${trackingNumber}`);
                    }
                }
            });
            
            console.log('ãƒãƒƒãƒ—æ§‹ç¯‰å®Œäº†:', {
                phoneMapSize: Object.keys(phoneMap).length,
                nameAddressMapSize: Object.keys(nameAddressMap).length
            });
            
            // é›»è©±ç•ªå·ãƒãƒƒãƒ—ã®ã‚µãƒ³ãƒ—ãƒ«ã‚’è¡¨ç¤º
            const phoneMapEntries = Object.entries(phoneMap).slice(0, 5);
            console.log('é›»è©±ç•ªå·ãƒãƒƒãƒ—ã‚µãƒ³ãƒ—ãƒ«:', phoneMapEntries);
            
            return { phoneMap, nameAddressMap };
        }

        // è¿½è·¡ç•ªå·ã‚’æ¤œç´¢ï¼ˆä¿®æ­£ç‰ˆï¼‰
        function findTrackingNumber(order, trackingMap) {
            // 1. é›»è©±ç•ªå·ãƒãƒƒãƒãƒ³ã‚°ï¼ˆbuyer-phone-numberã‚’ä½¿ç”¨ï¼‰
            const shipPhone = order['buyer-phone-number']; // æ­£ã—ã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã«ä¿®æ­£
            const normalizedShipPhone = normalizePhone(shipPhone);
            
            console.log(`æ³¨æ–‡ ${order['order-id']}: buyer-phone-number="${shipPhone}" â†’ normalized="${normalizedShipPhone}"`);
            
            if (normalizedShipPhone && trackingMap.phoneMap[normalizedShipPhone]) {
                console.log(`  âœ… é›»è©±ç•ªå·ä¸€è‡´: ${normalizedShipPhone} â†’ è¿½è·¡ç•ªå· ${trackingMap.phoneMap[normalizedShipPhone]}`);
                return {
                    trackingNumber: trackingMap.phoneMap[normalizedShipPhone],
                    matchType: 'phone'
                };
            }
            
            // 2. åå‰+ä½æ‰€ãƒãƒƒãƒãƒ³ã‚°
            const name = (order['recipient-name'] || '').trim();
            const address = normalizeAddress(
                (order['ship-address-1'] || '') + 
                (order['ship-address-2'] || '') + 
                (order['ship-city'] || '')
            );
            
            console.log(`  å—å–äººå: "${name}", ä½æ‰€: "${address}"`);
            
            if (name && address) {
                const nameAddressKey = `${name}|${address}`;
                if (trackingMap.nameAddressMap[nameAddressKey]) {
                    console.log(`  âœ… åå‰+ä½æ‰€ä¸€è‡´: ${nameAddressKey} â†’ è¿½è·¡ç•ªå· ${trackingMap.nameAddressMap[nameAddressKey]}`);
                    return {
                        trackingNumber: trackingMap.nameAddressMap[nameAddressKey],
                        matchType: 'name-address'
                    };
                }
                
                // 3. ã‚ã„ã¾ã„ä¸€è‡´
                const fuzzyResult = fuzzyMatch(name, address, trackingMap.nameAddressMap);
                if (fuzzyResult) {
                    console.log(`  âš ï¸ ã‚ã„ã¾ã„ä¸€è‡´: â†’ è¿½è·¡ç•ªå· ${fuzzyResult.trackingNumber}`);
                    return fuzzyResult;
                }
            }
            
            console.log(`  âŒ ä¸€è‡´ãªã—`);
            return null;
        }

        // é›»è©±ç•ªå·æ­£è¦åŒ–
        function normalizePhone(phone) {
            if (!phone || phone === '0') return null;
            
            // ãƒã‚¤ãƒ•ãƒ³ãƒ»ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
            let normalized = phone.replace(/[-\s]/g, '');
            
            // æ•°å­—ã®ã¿ã‹ãƒã‚§ãƒƒã‚¯
            if (!/^\d+$/.test(normalized)) return null;
            
            // 9æ¡ã®å ´åˆï¼ˆå›ºå®šé›»è©±ã®å…ˆé ­0ãªã—ï¼‰â†’ å…ˆé ­ã«0ã‚’è¿½åŠ ã—ã¦10æ¡ã«
            if (normalized.length === 9 && !normalized.startsWith('0')) {
                normalized = '0' + normalized;
            }
            
            // 10æ¡ã®å ´åˆï¼ˆæºå¸¯é›»è©±ã®å…ˆé ­0ãªã—ï¼‰â†’ å…ˆé ­ã«0ã‚’è¿½åŠ ã—ã¦11æ¡ã«
            if (normalized.length === 10 && !normalized.startsWith('0')) {
                normalized = '0' + normalized;
            }
            
            // 11æ¡ã§å…ˆé ­ãŒ0ã®å ´åˆã¯ãã®ã¾ã¾ï¼ˆæºå¸¯é›»è©±ï¼‰
            if (normalized.length === 11 && normalized.startsWith('0')) {
                return normalized;
            }
            
            // 10æ¡ã§å…ˆé ­ãŒ0ã®å ´åˆã‚‚ãã®ã¾ã¾ï¼ˆå›ºå®šé›»è©±ï¼‰
            if (normalized.length === 10 && normalized.startsWith('0')) {
                return normalized;
            }
            
            console.log(`é›»è©±ç•ªå·æ­£è¦åŒ–å¤±æ•—: "${phone}" â†’ "${normalized}" (${normalized.length}æ¡)`);
            return null;
        }

        // ä½æ‰€æ­£è¦åŒ–
        function normalizeAddress(address) {
            return address
                .replace(/\s+/g, '') // ç©ºç™½é™¤å»
                .replace(/[ï¼-ï¼™]/g, (s) => // å…¨è§’æ•°å­—â†’åŠè§’
                    String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .toLowerCase();
        }

        // ã‚ã„ã¾ã„ãƒãƒƒãƒãƒ³ã‚°
        function fuzzyMatch(targetName, targetAddress, nameAddressMap) {
            let bestMatch = null;
            let bestScore = 0;
            
            for (const [key, trackingNumber] of Object.entries(nameAddressMap)) {
                const [name, address] = key.split('|');
                const nameScore = calculateSimilarity(targetName, name);
                const addressScore = calculateSimilarity(targetAddress, address);
                const totalScore = (nameScore + addressScore) / 2;
                
                if (totalScore > 0.8 && totalScore > bestScore) {
                    bestMatch = trackingNumber;
                    bestScore = totalScore;
                }
            }
            
            return bestMatch ? {
                trackingNumber: bestMatch,
                matchType: 'fuzzy'
            } : null;
        }

        // æ–‡å­—åˆ—é¡ä¼¼åº¦è¨ˆç®—ï¼ˆç°¡æ˜“ç‰ˆï¼‰
        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 1;
            if (!str1 || !str2) return 0;
            
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // ãƒ¬ãƒ¼ãƒ™ãƒ³ã‚·ãƒ¥ã‚¿ã‚¤ãƒ³è·é›¢
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // å‡ºè·æ—¥ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatShipDate(dateStr) {
            if (!dateStr) return new Date().toISOString().split('T')[0];
            
            // æ—¢ã«YYYY-MM-DDå½¢å¼ã®å ´åˆã¯ãã®ã¾ã¾è¿”ã™
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // ãã®ä»–ã®å½¢å¼ã¯ä»Šæ—¥ã®æ—¥ä»˜ã‚’ä½¿ç”¨
            return new Date().toISOString().split('T')[0];
        }

        // é…é€æ¥­è€…ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—
        function getCarrierCode(carrierInfo) {
            if (!carrierInfo) return 'YAMATO';
            
            if (carrierInfo.includes('ãƒ¤ãƒãƒˆ') || carrierInfo.includes('YAMATO')) return 'YAMATO';
            if (carrierInfo.includes('ä½å·') || carrierInfo.includes('SAGAWA')) return 'SAGAWA';
            if (carrierInfo.includes('éƒµä¾¿') || carrierInfo.includes('Japan Post')) return 'Japan Post';
            if (carrierInfo.includes('ãƒ•ã‚§ãƒ‡ãƒƒã‚¯ã‚¹') || carrierInfo.includes('FEDEX')) return 'FEDEX';
            
            return 'YAMATO'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }

        // é…é€æ¥­è€…åã‚’å–å¾—
        function getCarrierName(carrierInfo) {
            if (!carrierInfo) return 'ãƒ¤ãƒãƒˆé‹è¼¸';
            
            if (carrierInfo.includes('ãƒ¤ãƒãƒˆ') || carrierInfo.includes('YAMATO')) return 'ãƒ¤ãƒãƒˆé‹è¼¸';
            if (carrierInfo.includes('ä½å·') || carrierInfo.includes('SAGAWA')) return 'ä½å·æ€¥ä¾¿';
            if (carrierInfo.includes('éƒµä¾¿') || carrierInfo.includes('Japan Post')) return 'æ—¥æœ¬éƒµä¾¿';
            if (carrierInfo.includes('ãƒ•ã‚§ãƒ‡ãƒƒã‚¯ã‚¹') || carrierInfo.includes('FEDEX')) return 'ãƒ•ã‚§ãƒ‡ãƒƒã‚¯ã‚¹';
            
            return 'ãƒ¤ãƒãƒˆé‹è¼¸'; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
        }

        // å‡¦ç†çµæœã‚’è¡¨ç¤º
        function displayResult(data, unmatchedCount) {
            const resultSection = document.getElementById('result-section');
            const resultContent = document.getElementById('result-content');
            
            const matchedCount = data.filter(row => row['tracking-number']).length;
            const totalCount = data.length;
            
            let resultHtml = '';
            
            // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            resultHtml += `
                <div class="mb-4 p-4 bg-green-50 border border-green-200 rounded-lg">
                    <h3 class="font-semibold text-green-800 mb-2">âœ… å‡¦ç†å®Œäº†</h3>
                    <p class="text-green-700">
                        <strong>ç·æ³¨æ–‡æ•°:</strong> ${totalCount}ä»¶<br>
                        <strong>è¿½è·¡ç•ªå·ãƒãƒƒãƒ:</strong> ${matchedCount}ä»¶<br>
                        <strong>ãƒãƒƒãƒç‡:</strong> ${Math.round((matchedCount / totalCount) * 100)}%
                    </p>
                </div>
            `;
            
            // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆæœªãƒãƒƒãƒãŒã‚ã‚‹å ´åˆï¼‰
            if (unmatchedCount > 0) {
                resultHtml += `
                    <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                        <h3 class="font-semibold text-yellow-800 mb-2">âš ï¸ æœªãƒãƒƒãƒæ³¨æ–‡</h3>
                        <p class="text-yellow-700">
                            ${unmatchedCount}ä»¶ã®æ³¨æ–‡ã§è¿½è·¡ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚<br>
                            æ‰‹å‹•ã§è¿½è·¡ç•ªå·ã‚’å…¥åŠ›ã™ã‚‹ã‹ã€è¿½è·¡ç•ªå·CSVã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚
                        </p>
                    </div>
                `;
            }
            
            // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æ¡ˆå†…
            resultHtml += `
                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                    <h3 class="font-semibold text-blue-800 mb-2">ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æº–å‚™å®Œäº†</h3>
                    <p class="text-blue-700">
                        å‡ºè·é€šçŸ¥ãƒ•ã‚¡ã‚¤ãƒ«ãŒæº–å‚™ã§ãã¾ã—ãŸã€‚ã€ŒTXTãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
                    </p>
                </div>
            `;
            
            resultContent.innerHTML = resultHtml;
            resultSection.style.display = 'block';
        }

        // TXTãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        function downloadTxt() {
            if (processedData.length === 0) {
                alert('ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«å‡¦ç†ã—ã¦ãã ã•ã„');
                return;
            }

            // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ä½œæˆ
            const headers = [
                'TemplateType=OrderFulfillment',
                'Version=2011.1102',
                'ã“ã®è¡Œã¯AmazonãŒä½¿ç”¨ã—ã¾ã™ã®ã§å¤‰æ›´ã‚„å‰Šé™¤ã—ãªã„ã§ãã ã•ã„ã€‚'
            ];

            const columnHeaders = [
                'æ³¨æ–‡ç•ªå·', 'æ³¨æ–‡å•†å“ç•ªå·', 'å‡ºè·æ•°', 'å‡ºè·æ—¥', 'é…é€æ¥­è€…ã‚³ãƒ¼ãƒ‰', 'é…é€æ¥­è€…å',
                'ãŠå•ã„åˆã‚ã›ä¼ç¥¨ç•ªå·', 'é…é€æ–¹æ³•', 'ä»£é‡‘å¼•æ›', 'è£½å“ãŒé€æ˜ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹å ´åˆã®è£½å“ã®é€æ˜ã‚³ãƒ¼ãƒ‰ã€‚',
                'å‡ºè·å…ƒä½æ‰€-åç§°', 'å‡ºè·å…ƒä½æ‰€-è¡Œ 1', 'å‡ºè·å…ƒä½æ‰€-è¡Œ 2', 'å‡ºè·å…ƒä½æ‰€-è¡Œ 3',
                'å‡ºè·å…ƒä½æ‰€-å¸‚ç”ºæ‘', 'å‡ºè·å…ƒä½æ‰€-éƒ¡', 'å‡ºè·å…ƒä½æ‰€-å·ãƒ»çœ', 'å‡ºè·å…ƒä½æ‰€-éƒµä¾¿ç•ªå·',
                'å‡ºè·å…ƒä½æ‰€-å›½ã‚³ãƒ¼ãƒ‰'
            ];

            const columnIds = [
                'order-id', 'order-item-id', 'quantity', 'ship-date', 'carrier-code', 'carrier-name',
                'tracking-number', 'ship-method', 'cod-collection-method', 'transparency_code',
                'ship_from_address_name', 'ship_from_address_line1', 'ship_from_address_line2',
                'ship_from_address_line3', 'ship_from_address_city', 'ship_from_address_county',
                'ship_from_address_state_or_region', 'ship_from_address_postalcode', 'ship_from_address_countrycode'
            ];

            // ãƒ‡ãƒ¼ã‚¿è¡Œã‚’ä½œæˆ
            const dataRows = processedData.map(row => 
                columnIds.map(id => row[id] || '').join('\t')
            );

            // å…¨ã¦ã®è¡Œã‚’çµåˆ
            const content = [
                headers.join('\t'),
                columnHeaders.join('\t'),
                columnIds.join('\t'),
                ...dataRows
            ].join('\n');

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shipping_notification_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
