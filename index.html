<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazonå‡ºè·é€šçŸ¥å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-lg p-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-8 text-center">
                ğŸ“¦ Amazonå‡ºè·é€šçŸ¥å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ 
            </h1>

            <!-- ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º -->
            <div class="mb-8">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center">
                        <div id="step1-indicator" class="w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-2">1</div>
                        <span class="text-sm font-medium">ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-200 mx-4">
                        <div id="progress1" class="h-1 bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="step2-indicator" class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold mr-2">2</div>
                        <span class="text-sm font-medium">ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ</span>
                    </div>
                    <div class="flex-1 h-1 bg-gray-200 mx-4">
                        <div id="progress2" class="h-1 bg-blue-500 transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div class="flex items-center">
                        <div id="step3-indicator" class="w-8 h-8 bg-gray-300 text-gray-600 rounded-full flex items-center justify-center font-bold mr-2">3</div>
                        <span class="text-sm font-medium">ãƒ‡ãƒ¼ã‚¿å‡¦ç†</span>
                    </div>
                </div>
            </div>

            <!-- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿çŠ¶æ³ -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <h3 class="font-semibold text-blue-800 mb-2">ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«çŠ¶æ³</h3>
                <div id="template-status" class="text-blue-700">
                    <div class="flex items-center">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-500 mr-2"></div>
                        ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿ä¸­...
                    </div>
                </div>
            </div>

            <!-- ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠã‚¨ãƒªã‚¢ -->
            <div class="grid md:grid-cols-2 gap-6 mb-6">
                <!-- Amazonæ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆ -->
                <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 transition-colors">
                    <h3 class="font-semibold text-gray-700 mb-2">ğŸ“Š Amazonæ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆ</h3>
                    <p class="text-sm text-gray-600 mb-3">TSVå½¢å¼ (.txt)</p>
                    <input type="file" id="amazon-file" accept=".txt" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="amazon-status" class="mt-2 text-sm"></div>
                </div>

                <!-- è¿½è·¡ç•ªå·CSV -->
                <div class="p-4 border-2 border-dashed border-gray-300 rounded-lg hover:border-blue-400 transition-colors">
                    <h3 class="font-semibold text-gray-700 mb-2">ğŸšš è¿½è·¡ç•ªå·CSV</h3>
                    <p class="text-sm text-gray-600 mb-3">CSVå½¢å¼ (.csv)</p>
                    <input type="file" id="tracking-file" accept=".csv" class="w-full p-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <div id="tracking-status" class="mt-2 text-sm"></div>
                </div>
            </div>

            <!-- å‡¦ç†ãƒœã‚¿ãƒ³ -->
            <div class="text-center mb-6">
                <button id="process-btn" 
                        class="bg-blue-500 hover:bg-blue-600 disabled:bg-gray-400 text-white font-bold py-3 px-8 rounded-lg transition-colors disabled:cursor-not-allowed"
                        disabled>
                    ğŸ”„ ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦å‡ºè·é€šçŸ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆ
                </button>
            </div>

            <!-- çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="results" class="hidden">
                <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
                    <h3 class="font-semibold text-green-800 mb-2">âœ… å‡¦ç†å®Œäº†</h3>
                    <div id="results-summary" class="text-green-700"></div>
                </div>

                <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                    <h3 class="font-semibold text-gray-800 mb-2">ğŸ“ˆ ãƒãƒƒãƒãƒ³ã‚°è©³ç´°</h3>
                    <div id="matching-details" class="text-gray-700 text-sm"></div>
                </div>
            </div>

            <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢ -->
            <div id="error-message" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
                <h3 class="font-semibold text-red-800 mb-2">âŒ ã‚¨ãƒ©ãƒ¼</h3>
                <div id="error-text" class="text-red-700"></div>
            </div>

            <!-- é€²è¡ŒçŠ¶æ³è¡¨ç¤º -->
            <div id="progress-area" class="hidden">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h3 class="font-semibold text-blue-800 mb-2">âš™ï¸ å‡¦ç†ä¸­...</h3>
                    <div class="w-full bg-blue-200 rounded-full h-2 mb-2">
                        <div id="progress-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <div id="progress-text" class="text-blue-700 text-sm">å‡¦ç†ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...</div>
                </div>
            </div>
        </div>

        <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
        <div class="text-center mt-8 text-gray-600 text-sm">
            <p>Amazonå‡ºè·é€šçŸ¥å‡¦ç†ã‚·ã‚¹ãƒ†ãƒ  v1.0.0</p>
            <p>å¯¾å¿œé…é€æ¥­è€…: ãƒ¤ãƒãƒˆé‹è¼¸ãƒ»ä½å·æ€¥ä¾¿ãƒ»æ—¥æœ¬éƒµä¾¿ãƒ»ãƒ•ã‚§ãƒ‡ãƒƒã‚¯ã‚¹</p>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let templateData = null;
        let amazonOrders = [];
        let trackingData = [];

        // åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadTemplate();
            setupEventListeners();
        });

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
        async function loadTemplate() {
            try {
                const response = await fetch('Flat.File.ShippingConfirmation.jp.xls');
                if (!response.ok) {
                    throw new Error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                
                // æœ€åˆã®ã‚·ãƒ¼ãƒˆã‚’å–å¾—
                const sheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[sheetName];
                
                // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’å–å¾—ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ§‹é€ ã®ç¢ºèªï¼‰
                const headers = XLSX.utils.sheet_to_json(worksheet, { header: 1 })[0];
                templateData = { workbook, headers };
                
                updateTemplateStatus(true, `âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å®Œäº† (${headers.length}åˆ—)`);
                updateStep(1, true);
                
            } catch (error) {
                console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                updateTemplateStatus(false, `âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆèª­ã¿è¾¼ã¿å¤±æ•—: ${error.message}`);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        function setupEventListeners() {
            document.getElementById('amazon-file').addEventListener('change', handleAmazonFile);
            document.getElementById('tracking-file').addEventListener('change', handleTrackingFile);
            document.getElementById('process-btn').addEventListener('click', processData);
        }

        // ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºã®æ›´æ–°
        function updateStep(step, completed) {
            const indicator = document.getElementById(`step${step}-indicator`);
            const progress = document.getElementById(`progress${step}`);
            
            if (completed) {
                indicator.className = 'w-8 h-8 bg-green-500 text-white rounded-full flex items-center justify-center font-bold mr-2';
                indicator.innerHTML = 'âœ“';
                if (progress) progress.style.width = '100%';
                
                // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
                if (step < 3) {
                    const nextIndicator = document.getElementById(`step${step + 1}-indicator`);
                    nextIndicator.className = 'w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center font-bold mr-2';
                }
            }
        }

        // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆçŠ¶æ³ã®æ›´æ–°
        function updateTemplateStatus(success, message) {
            const statusElement = document.getElementById('template-status');
            statusElement.innerHTML = message;
            statusElement.className = success ? 'text-green-700' : 'text-red-700';
        }

        // Amazonãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
        async function handleAmazonFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const content = await readFileAsText(file);
                amazonOrders = parseAmazonReport(content);
                
                const statusElement = document.getElementById('amazon-status');
                statusElement.innerHTML = `âœ… ${amazonOrders.length}ä»¶ã®æ³¨æ–‡ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
                statusElement.className = 'text-green-600';
                
                updateStep(2, amazonOrders.length > 0 && trackingData.length > 0);
                updateProcessButton();
                
            } catch (error) {
                console.error('Amazonãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const statusElement = document.getElementById('amazon-status');
                statusElement.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                statusElement.className = 'text-red-600';
            }
        }

        // è¿½è·¡ç•ªå·ãƒ•ã‚¡ã‚¤ãƒ«ã®å‡¦ç†
        async function handleTrackingFile(event) {
            const file = event.target.files[0];
            if (!file) return;

            try {
                const content = await readFileAsText(file, 'Shift_JIS');
                trackingData = parseTrackingCSV(content);
                
                const statusElement = document.getElementById('tracking-status');
                statusElement.innerHTML = `âœ… ${trackingData.length}ä»¶ã®è¿½è·¡æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ`;
                statusElement.className = 'text-green-600';
                
                updateStep(2, amazonOrders.length > 0 && trackingData.length > 0);
                updateProcessButton();
                
            } catch (error) {
                console.error('è¿½è·¡ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
                const statusElement = document.getElementById('tracking-status');
                statusElement.innerHTML = `âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`;
                statusElement.className = 'text-red-600';
            }
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿é–¢æ•°
        function readFileAsText(file, encoding = 'UTF-8') {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = e => reject(new Error('ãƒ•ã‚¡ã‚¤ãƒ«èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ'));
                
                if (encoding === 'Shift_JIS') {
                    reader.readAsText(file, 'Shift_JIS');
                } else {
                    reader.readAsText(file, 'UTF-8');
                }
            });
        }

        // é›»è©±ç•ªå·ã®æ­£è¦åŒ–
        function normalizePhoneNumber(phone) {
            if (!phone) return '';
            
            // ãƒã‚¤ãƒ•ãƒ³ã€ã‚¹ãƒšãƒ¼ã‚¹ã€æ‹¬å¼§ã‚’é™¤å»
            let normalized = phone.replace(/[-\s()]/g, '');
            
            // å…ˆé ­ãŒ0ã§ãªã„å ´åˆã¯0ã‚’è¿½åŠ 
            if (normalized && !normalized.startsWith('0') && !normalized.startsWith('+')) {
                normalized = '0' + normalized;
            }
            
            return normalized;
        }

        // Amazonæ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆã®è§£æ
        function parseAmazonReport(content) {
            console.log('Amazonæ³¨æ–‡ãƒ¬ãƒãƒ¼ãƒˆã‚’è§£æä¸­...');
            const lines = content.split('\n').filter(line => line.trim());
            if (lines.length === 0) return [];

            const headers = lines[0].split('\t');
            console.log('ãƒ˜ãƒƒãƒ€ãƒ¼æ•°:', headers.length);
            console.log('ä¸»è¦ãƒ˜ãƒƒãƒ€ãƒ¼:', headers.slice(0, 15));

            // é‡è¦ãªãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—
            const indices = {
                orderId: headers.indexOf('order-id'),
                buyerPhone: headers.indexOf('buyer-phone-number'),
                recipientName: headers.indexOf('recipient-name'),
                shipAddress1: headers.indexOf('ship-address-1'),
                shipAddress2: headers.indexOf('ship-address-2'),
                shipAddress3: headers.indexOf('ship-address-3'),
                shipCity: headers.indexOf('ship-city'),
                shipState: headers.indexOf('ship-state'),
                shipPostalCode: headers.indexOf('ship-postal-code')
            };

            console.log('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹:', indices);

            // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèª
            const missingFields = Object.entries(indices)
                .filter(([key, index]) => index === -1)
                .map(([key]) => key);

            if (missingFields.length > 0) {
                console.warn('è¦‹ã¤ã‹ã‚‰ãªã„ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', missingFields);
            }

            const orders = [];
            for (let i = 1; i < lines.length; i++) {
                const fields = lines[i].split('\t');
                if (fields.length < Math.max(...Object.values(indices).filter(idx => idx !== -1))) {
                    console.warn(`è¡Œ${i+1}: ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰æ•°ãŒä¸è¶³ (${fields.length})`);
                    continue;
                }

                const order = {
                    orderId: fields[indices.orderId] || '',
                    buyerPhone: normalizePhoneNumber(fields[indices.buyerPhone] || ''),
                    recipientName: (fields[indices.recipientName] || '').trim(),
                    shipAddress1: (fields[indices.shipAddress1] || '').trim(),
                    shipAddress2: (fields[indices.shipAddress2] || '').trim(),
                    shipAddress3: (fields[indices.shipAddress3] || '').trim(),
                    shipCity: (fields[indices.shipCity] || '').trim(),
                    shipState: (fields[indices.shipState] || '').trim(),
                    shipPostalCode: (fields[indices.shipPostalCode] || '').trim()
                };

                // ãƒ‡ãƒãƒƒã‚°ç”¨: æœ€åˆã®5ä»¶ã®è©³ç´°ã‚’è¡¨ç¤º
                if (i <= 5) {
                    console.log(`æ³¨æ–‡${i}:`, {
                        orderId: order.orderId,
                        phone: order.buyerPhone,
                        name: order.recipientName,
                        address: order.shipAddress1
                    });
                }

                // åŸºæœ¬æƒ…å ±ãŒã‚ã‚‹ã‚‚ã®ã®ã¿è¿½åŠ 
                if (order.orderId && (order.buyerPhone || order.recipientName)) {
                    orders.push(order);
                }
            }

            console.log(`${orders.length}ä»¶ã®æ³¨æ–‡ã‚’è§£æã—ã¾ã—ãŸ`);
            return orders;
        }

        // è¿½è·¡ç•ªå·CSVã®è§£æ
        function parseTrackingCSV(content) {
            console.log('è¿½è·¡ç•ªå·CSVã‚’è§£æä¸­...');
            
            const result = Papa.parse(content, {
                dynamicTyping: true,
                skipEmptyLines: true,
                delimitersToGuess: [',', '\t', '|', ';']
            });

            if (result.errors.length > 0) {
                console.warn('CSVè§£æè­¦å‘Š:', result.errors);
            }

            const data = result.data;
            if (data.length === 0) return [];

            console.log('CSVè§£æçµæœ:', data.slice(0, 3));

            const trackingList = [];
            for (let i = 0; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length < 16) continue;

                const tracking = {
                    trackingNumber: String(row[3] || '').trim(), // Dåˆ—
                    phone: normalizePhoneNumber(String(row[8] || '')), // Iåˆ—
                    address1: String(row[11] || '').trim(), // Låˆ—
                    address2: String(row[12] || '').trim(), // Måˆ—
                    name: String(row[15] || '').trim() // Påˆ—
                };

                // ãƒ‡ãƒãƒƒã‚°ç”¨: æœ€åˆã®5ä»¶ã®è©³ç´°ã‚’è¡¨ç¤º
                if (i < 5) {
                    console.log(`è¿½è·¡${i+1}:`, tracking);
                }

                // è¿½è·¡ç•ªå·ãŒã‚ã‚‹ã‚‚ã®ã®ã¿è¿½åŠ 
                if (tracking.trackingNumber) {
                    trackingList.push(tracking);
                }
            }

            console.log(`${trackingList.length}ä»¶ã®è¿½è·¡æƒ…å ±ã‚’è§£æã—ã¾ã—ãŸ`);
            return trackingList;
        }

        // æ–‡å­—åˆ—é¡ä¼¼åº¦è¨ˆç®—ï¼ˆJaro-Winklerè·é›¢ã®ç°¡æ˜“ç‰ˆï¼‰
        function calculateSimilarity(str1, str2) {
            if (!str1 || !str2) return 0;
            if (str1 === str2) return 1;

            const len1 = str1.length;
            const len2 = str2.length;
            const maxDistance = Math.floor(Math.max(len1, len2) / 2) - 1;

            let matches = 0;
            const str1Matches = new Array(len1).fill(false);
            const str2Matches = new Array(len2).fill(false);

            // ãƒãƒƒãƒã™ã‚‹æ–‡å­—ã‚’è¦‹ã¤ã‘ã‚‹
            for (let i = 0; i < len1; i++) {
                const start = Math.max(0, i - maxDistance);
                const end = Math.min(i + maxDistance + 1, len2);

                for (let j = start; j < end; j++) {
                    if (str2Matches[j] || str1[i] !== str2[j]) continue;
                    str1Matches[i] = true;
                    str2Matches[j] = true;
                    matches++;
                    break;
                }
            }

            if (matches === 0) return 0;

            // è»¢ç½®ã®è¨ˆç®—
            let transpositions = 0;
            let k = 0;
            for (let i = 0; i < len1; i++) {
                if (!str1Matches[i]) continue;
                while (!str2Matches[k]) k++;
                if (str1[i] !== str2[k]) transpositions++;
                k++;
            }

            const jaro = (matches / len1 + matches / len2 + (matches - transpositions / 2) / matches) / 3;
            return jaro;
        }

        // é…é€æ¥­è€…ã‚³ãƒ¼ãƒ‰ã®æ±ºå®šï¼ˆè¿½è·¡ç•ªå·å½¢å¼ã®å³å¯†ãƒã‚§ãƒƒã‚¯ï¼‰
        function getCarrierCode(trackingNumber) {
            if (!trackingNumber) return 'YAMATO';

            const tracking = trackingNumber.toString().replace(/[-\s]/g, '');
            
            // ãƒ¤ãƒãƒˆé‹è¼¸: 12æ¡ã®æ•°å­—ï¼ˆä¾‹ï¼š767076335325ï¼‰
            if (/^\d{12}$/.test(tracking)) {
                return 'YAMATO';
            }
            
            // ä½å·æ€¥ä¾¿: 10-12æ¡ã®æ•°å­—
            if (/^\d{10,12}$/.test(tracking) && !tracking.startsWith('7670')) {
                return 'SAGAWA';
            }
            
            // æ—¥æœ¬éƒµä¾¿: ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ2æ–‡å­—+æ•°å­—9æ¡+ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ2æ–‡å­—
            if (/^[A-Z]{2}\d{9}[A-Z]{2}$/.test(tracking)) {
                return 'Japan Post';
            }
            
            // ãƒ•ã‚§ãƒ‡ãƒƒã‚¯ã‚¹: 14æ¡ã¾ãŸã¯20æ¡ã®æ•°å­—
            if (/^\d{14}$/.test(tracking) || /^\d{20}$/.test(tracking)) {
                return 'FEDEX';
            }

            // æ•°å­—ã®ã¿ã§11æ¡ã®å ´åˆã‚‚ãƒ¤ãƒãƒˆé‹è¼¸ã®å¯èƒ½æ€§
            if (/^\d{11}$/.test(tracking)) {
                return 'YAMATO';
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ãƒ¤ãƒãƒˆé‹è¼¸
            return 'YAMATO';
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒãƒ³ã‚°å‡¦ç†
        function matchData() {
            console.log('ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒãƒ³ã‚°ã‚’é–‹å§‹...');
            
            const matches = {
                phoneExact: 0,
                phoneNormalized: 0,
                nameAddress: 0,
                fuzzy: 0,
                unmatched: 0
            };

            const matchedOrders = [];

            for (const order of amazonOrders) {
                let bestMatch = null;
                let matchType = 'unmatched';

                // 1. é›»è©±ç•ªå·ã§ã®å®Œå…¨ä¸€è‡´
                if (order.buyerPhone) {
                    bestMatch = trackingData.find(track => 
                        track.phone && track.phone === order.buyerPhone
                    );
                    if (bestMatch) {
                        matchType = 'phoneExact';
                        matches.phoneExact++;
                    }
                }

                // 2. é›»è©±ç•ªå·ã®æ­£è¦åŒ–ä¸€è‡´
                if (!bestMatch && order.buyerPhone) {
                    const normalizedOrderPhone = normalizePhoneNumber(order.buyerPhone);
                    bestMatch = trackingData.find(track => {
                        const normalizedTrackPhone = normalizePhoneNumber(track.phone);
                        return normalizedTrackPhone && normalizedTrackPhone === normalizedOrderPhone;
                    });
                    if (bestMatch) {
                        matchType = 'phoneNormalized';
                        matches.phoneNormalized++;
                    }
                }

                // 3. åå‰ï¼‹ä½æ‰€ã§ã®ä¸€è‡´
                if (!bestMatch && order.recipientName && order.shipAddress1) {
                    bestMatch = trackingData.find(track => 
                        track.name && track.address1 &&
                        track.name.includes(order.recipientName.replace(/\s/g, '')) &&
                        track.address1.includes(order.shipAddress1.replace(/\s/g, ''))
                    );
                    if (bestMatch) {
                        matchType = 'nameAddress';
                        matches.nameAddress++;
                    }
                }

                // 4. ã‚ã„ã¾ã„ãƒãƒƒãƒãƒ³ã‚°ï¼ˆé¡ä¼¼åº¦80%ä»¥ä¸Šï¼‰
                if (!bestMatch && order.recipientName) {
                    let maxSimilarity = 0;
                    let fuzzyMatch = null;

                    for (const track of trackingData) {
                        if (!track.name) continue;
                        
                        const similarity = calculateSimilarity(
                            order.recipientName.replace(/\s/g, ''),
                            track.name.replace(/\s/g, '')
                        );

                        if (similarity > maxSimilarity && similarity >= 0.8) {
                            maxSimilarity = similarity;
                            fuzzyMatch = track;
                        }
                    }

                    if (fuzzyMatch) {
                        bestMatch = fuzzyMatch;
                        matchType = 'fuzzy';
                        matches.fuzzy++;
                    }
                }

                // ãƒãƒƒãƒã—ãªã‹ã£ãŸå ´åˆ
                if (!bestMatch) {
                    matches.unmatched++;
                }

                // çµæœã‚’è¨˜éŒ²
                matchedOrders.push({
                    order,
                    tracking: bestMatch,
                    matchType,
                    carrierCode: bestMatch ? getCarrierCode(bestMatch.trackingNumber) : 'YAMATO'
                });
            }

            console.log('ãƒãƒƒãƒãƒ³ã‚°çµæœ:', matches);
            return { matchedOrders, matches };
        }

        // å‡ºè·é€šçŸ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆ
        function generateShippingFile(matchedOrders) {
            console.log('å‡ºè·é€šçŸ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...');

            const headers = [
                'order-id', 'order-item-id', 'quantity', 'ship-date', 'carrier-code', 'carrier-name',
                'tracking-number', 'ship-method'
            ];

            const rows = [headers];
            
            // é‡è¤‡è¿½è·¡ç•ªå·ã®å‡¦ç†
            const duplicateTrackingInfo = processDuplicateTrackingNumbers(matchedOrders);

            for (const match of matchedOrders) {
                if (!match.tracking) continue; // ãƒãƒƒãƒã—ãªã‹ã£ãŸã‚‚ã®ã¯ã‚¹ã‚­ãƒƒãƒ—

                const today = new Date().toISOString().split('T')[0];
                
                // é‡è¤‡è¿½è·¡ç•ªå·ã®å ´åˆã€æœ€åˆã®æ³¨æ–‡ã®ã¿ã«è¿½è·¡ç•ªå·ã‚’è¨­å®š
                let trackingNumber = match.tracking.trackingNumber;
                if (duplicateTrackingInfo.duplicates[trackingNumber]) {
                    // ã“ã®æ³¨æ–‡IDãŒæœ€åˆã®æ³¨æ–‡ã§ãªã„å ´åˆã¯è¿½è·¡ç•ªå·ã‚’ç©ºã«ã™ã‚‹
                    if (duplicateTrackingInfo.duplicates[trackingNumber].firstOrderId !== match.order.orderId) {
                        trackingNumber = '';
                    }
                }
                
                rows.push([
                    match.order.orderId,
                    '', // order-item-id ã¯ç©º
                    '1', // quantity
                    today,
                    match.carrierCode,
                    getCarrierName(match.carrierCode),
                    trackingNumber,
                    'Standard' // ship-method ã‚’æ˜ç¤ºçš„ã«è¨­å®š
                ]);
            }

            // TSVå½¢å¼ã§å‡ºåŠ›ï¼ˆUTF-8 BOMä»˜ãï¼‰
            const tsvContent = '\ufeff' + rows.map(row => row.join('\t')).join('\r\n');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆUTF-8 BOMä»˜ãï¼‰
            const blob = new Blob([tsvContent], { 
                type: 'text/plain;charset=utf-8-sig' 
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shipping_notification_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            return { 
                totalRows: rows.length - 1, // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’é™¤ã„ãŸä»¶æ•°
                duplicateInfo: duplicateTrackingInfo 
            };
        }

        // é‡è¤‡è¿½è·¡ç•ªå·ã®å‡¦ç†
        function processDuplicateTrackingNumbers(matchedOrders) {
            const trackingCounts = {};
            const duplicates = {};
            
            // è¿½è·¡ç•ªå·ã®å‡ºç¾å›æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
            for (const match of matchedOrders) {
                if (!match.tracking || !match.tracking.trackingNumber) continue;
                
                const trackingNumber = match.tracking.trackingNumber;
                if (!trackingCounts[trackingNumber]) {
                    trackingCounts[trackingNumber] = {
                        count: 0,
                        orders: []
                    };
                }
                trackingCounts[trackingNumber].count++;
                trackingCounts[trackingNumber].orders.push(match);
            }
            
            // é‡è¤‡ã—ã¦ã„ã‚‹è¿½è·¡ç•ªå·ã‚’ç‰¹å®š
            let duplicateTrackingCount = 0;
            let duplicateOrderCount = 0;
            
            for (const [trackingNumber, info] of Object.entries(trackingCounts)) {
                if (info.count > 1) {
                    duplicateTrackingCount++;
                    duplicateOrderCount += info.count;
                    
                    // æœ€åˆã®æ³¨æ–‡ã‚’ç‰¹å®šï¼ˆæ³¨æ–‡IDã§ã‚½ãƒ¼ãƒˆï¼‰
                    info.orders.sort((a, b) => a.order.orderId.localeCompare(b.order.orderId));
                    
                    duplicates[trackingNumber] = {
                        count: info.count,
                        firstOrderId: info.orders[0].order.orderId,
                        allOrderIds: info.orders.map(match => match.order.orderId),
                        customerInfo: {
                            name: info.orders[0].order.recipientName,
                            phone: info.orders[0].order.buyerPhone,
                            address: info.orders[0].order.shipAddress1
                        }
                    };
                }
            }
            
            console.log(`é‡è¤‡è¿½è·¡ç•ªå·å‡¦ç†å®Œäº†: ${duplicateTrackingCount}ä»¶ã®è¿½è·¡ç•ªå·ãŒé‡è¤‡ (${duplicateOrderCount}æ³¨æ–‡)`);
            
            return {
                duplicates,
                duplicateTrackingCount,
                duplicateOrderCount
            };
        }

        // é…é€æ¥­è€…åã®å–å¾—
        function getCarrierName(carrierCode) {
            const carriers = {
                'YAMATO': 'ãƒ¤ãƒãƒˆé‹è¼¸',
                'SAGAWA': 'ä½å·æ€¥ä¾¿',
                'Japan Post': 'æ—¥æœ¬éƒµä¾¿',
                'FEDEX': 'ãƒ•ã‚§ãƒ‡ãƒƒã‚¯ã‚¹'
            };
            return carriers[carrierCode] || 'ãƒ¤ãƒãƒˆé‹è¼¸';
        }

        // å‡¦ç†ãƒœã‚¿ãƒ³ã®çŠ¶æ…‹æ›´æ–°
        function updateProcessButton() {
            const button = document.getElementById('process-btn');
            const canProcess = templateData && amazonOrders.length > 0 && trackingData.length > 0;
            
            button.disabled = !canProcess;
            if (canProcess) {
                button.className = 'bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-lg transition-colors';
            } else {
                button.className = 'bg-gray-400 text-white font-bold py-3 px-8 rounded-lg cursor-not-allowed';
            }
        }

        // é€²è¡ŒçŠ¶æ³ã®æ›´æ–°
        function updateProgress(percent, message) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            
            if (progressBar) progressBar.style.width = `${percent}%`;
            if (progressText) progressText.textContent = message;
        }

        // ã‚¨ãƒ©ãƒ¼è¡¨ç¤º
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            
            errorText.textContent = message;
            errorDiv.classList.remove('hidden');
            
            // 5ç§’å¾Œã«è‡ªå‹•çš„ã«éš ã™
            setTimeout(() => {
                errorDiv.classList.add('hidden');
            }, 5000);
        }

        // çµæœè¡¨ç¤º
        function showResults(result, totalCount, matches) {
            const resultsDiv = document.getElementById('results');
            const summaryDiv = document.getElementById('results-summary');
            const detailsDiv = document.getElementById('matching-details');

            const duplicateInfo = result.duplicateInfo;
            const duplicateWarning = duplicateInfo.duplicateTrackingCount > 0 ? 
                `<div class="mt-2 p-2 bg-yellow-100 border border-yellow-400 rounded text-yellow-800">
                    <strong>âš ï¸ é‡è¤‡è¿½è·¡ç•ªå·å¯¾å¿œ:</strong> ${duplicateInfo.duplicateTrackingCount}ä»¶ã®è¿½è·¡ç•ªå·ãŒé‡è¤‡ã—ã¦ã„ã¾ã—ãŸã€‚
                    æœ€åˆã®æ³¨æ–‡ã®ã¿ã«è¿½è·¡ç•ªå·ã‚’è¨­å®šã—ã€ä»–ã¯ç©ºç™½ã«ã—ã¾ã—ãŸã€‚
                </div>` : '';

            summaryDiv.innerHTML = `
                <p class="font-semibold">å‡ºè·é€šçŸ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆã—ã¾ã—ãŸ</p>
                <p>${result.totalRows}ä»¶ / ${totalCount}ä»¶ ã®æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿ã‚’å‡ºåŠ›ã—ã¾ã—ãŸ</p>
                ${duplicateWarning}
            `;

            detailsDiv.innerHTML = `
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center p-2 bg-green-100 rounded">
                        <div class="font-bold text-green-800">${matches.phoneExact}</div>
                        <div class="text-xs text-green-600">é›»è©±ç•ªå·å®Œå…¨ä¸€è‡´</div>
                    </div>
                    <div class="text-center p-2 bg-blue-100 rounded">
                        <div class="font-bold text-blue-800">${matches.phoneNormalized}</div>
                        <div class="text-xs text-blue-600">é›»è©±ç•ªå·æ­£è¦åŒ–ä¸€è‡´</div>
                    </div>
                    <div class="text-center p-2 bg-yellow-100 rounded">
                        <div class="font-bold text-yellow-800">${matches.nameAddress}</div>
                        <div class="text-xs text-yellow-600">åå‰+ä½æ‰€ä¸€è‡´</div>
                    </div>
                    <div class="text-center p-2 bg-purple-100 rounded">
                        <div class="font-bold text-purple-800">${matches.fuzzy}</div>
                        <div class="text-xs text-purple-600">ã‚ã„ã¾ã„ä¸€è‡´</div>
                    </div>
                </div>
                <div class="mt-2 text-center">
                    <span class="text-red-600 font-medium">æœªãƒãƒƒãƒ: ${matches.unmatched}ä»¶</span>
                </div>
            `;

            resultsDiv.classList.remove('hidden');
        }

        // ãƒ¡ã‚¤ãƒ³ã®å‡¦ç†é–¢æ•°
        async function processData() {
            try {
                // UIæ›´æ–°
                const progressArea = document.getElementById('progress-area');
                const resultsDiv = document.getElementById('results');
                const errorDiv = document.getElementById('error-message');
                
                progressArea.classList.remove('hidden');
                resultsDiv.classList.add('hidden');
                errorDiv.classList.add('hidden');

                // å‡¦ç†é–‹å§‹
                updateProgress(10, 'ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒãƒ³ã‚°ã‚’é–‹å§‹ã—ã¦ã„ã¾ã™...');
                
                // ãƒ‡ãƒ¼ã‚¿ãƒãƒƒãƒãƒ³ã‚°
                await new Promise(resolve => setTimeout(resolve, 500)); // UIæ›´æ–°ã®ãŸã‚ã®çŸ­ã„é…å»¶
                const { matchedOrders, matches } = matchData();
                
                updateProgress(60, 'ãƒãƒƒãƒãƒ³ã‚°å®Œäº†ã€‚å‡ºè·é€šçŸ¥ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆä¸­...');
                
                // å‡ºè·é€šçŸ¥ãƒ•ã‚¡ã‚¤ãƒ«ç”Ÿæˆ
                await new Promise(resolve => setTimeout(resolve, 500));
                const result = generateShippingFile(matchedOrders);
                
                updateProgress(100, 'å‡¦ç†å®Œäº†');
                
                // çµæœè¡¨ç¤º
                setTimeout(() => {
                    progressArea.classList.add('hidden');
                    showResults(result, amazonOrders.length, matches);
                    updateStep(3, true);
                }, 1000);
                
            } catch (error) {
                console.error('å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
                document.getElementById('progress-area').classList.add('hidden');
                showError(`å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${error.message}`);
            }
        }
    </script>
</body>
</html>
