<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon出荷通知処理システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-900 mb-8">
            Amazon出荷通知処理システム
        </h1>

        <div class="space-y-6">
            <!-- ファイルアップロード -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4">ファイル読み込み</h2>
                
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            Amazon注文レポートTXTファイル
                        </label>
                        <div class="relative">
                            <input
                                type="file"
                                id="txt-upload"
                                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
                            />
                            <label
                                for="txt-upload"
                                class="inline-flex items-center px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-md hover:bg-blue-700 cursor-pointer"
                            >
                                ファイルを選択
                            </label>
                            <span id="file-name" class="ml-3 text-sm text-gray-500"></span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Amazonセラーセントラルからダウンロードした注文レポート（TXTファイル）をそのままアップロードしてください
                        </p>
                    </div>
                </div>
            </div>

            <!-- 処理ボタン -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4">データ処理</h2>
                
                <div class="flex space-x-4">
                    <button
                        id="process-btn"
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled
                    >
                        データ処理実行
                    </button>
                    
                    <button
                        id="download-btn"
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled
                    >
                        TXTファイルダウンロード
                    </button>
                </div>
            </div>

            <!-- プレビュー -->
            <div id="preview-section" class="bg-white p-6 rounded-lg shadow" style="display: none;">
                <h2 class="text-lg font-semibold mb-4">処理結果プレビュー</h2>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-2 text-left">注文番号</th>
                                <th class="px-3 py-2 text-left">出荷日</th>
                                <th class="px-3 py-2 text-left">配送業者コード</th>
                                <th class="px-3 py-2 text-left">配送業者名</th>
                                <th class="px-3 py-2 text-left">追跡番号</th>
                            </tr>
                        </thead>
                        <tbody id="preview-tbody">
                        </tbody>
                    </table>
                    <p id="more-rows" class="text-gray-500 text-sm mt-2" style="display: none;"></p>
                </div>
            </div>

            <!-- 注意事項 -->
            <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">注意事項</h3>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>• Amazonセラーセントラルからダウンロードした注文レポートCSVをそのまま使用してください</li>
                    <li>• 出荷日・配送業者・追跡番号の情報を手動で入力する場合は、適切な形式で入力してください</li>
                    <li>• 生成されたTXTファイルをAmazonセラーセントラルの「注文関連ファイルをアップロード」にアップロードしてください</li>
                    <li>• テンプレートファイルは自動で読み込まれます</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let csvData = [];
        let templateData = [];
        let carrierList = [];
        let processedData = [];
        let templateLoaded = false;

        // キャリアコードマッピング
        const carrierCodeMap = {
            'ヤマト運輸': 'YAMATO',
            'YAMATO': 'YAMATO',
            '日本郵便': 'Japan Post',
            'Japan Post': 'Japan Post',
            '佐川急便': 'SAGAWA',
            'SAGAWA': 'SAGAWA',
            'フェデックス': 'FEDEX',
            'FEDEX': 'FEDEX'
        };

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            loadTemplateFile();
            setupEventListeners();
        });

        // イベントリスナー設定
        function setupEventListeners() {
            document.getElementById('txt-upload').addEventListener('change', handleTxtUpload);
            document.getElementById('process-btn').addEventListener('click', processData);
            document.getElementById('download-btn').addEventListener('click', downloadTxt);
        }

        // テンプレートファイルを自動読み込み
        async function loadTemplateFile() {
            try {
                const response = await fetch('./Flat.File.ShippingConfirmation.jp.xls');
                if (!response.ok) {
                    console.warn('テンプレートファイルが見つかりません');
                    return;
                }
                
                const fileContent = await response.arrayBuffer();
                const workbook = XLSX.read(fileContent, { type: 'array' });
                
                // テンプレートシートのヘッダー取得
                const templateSheet = workbook.Sheets['出荷通知テンプレート_Template'];
                templateData = XLSX.utils.sheet_to_json(templateSheet, { header: 1 });
                
                // 配送業者リスト取得
                const carrierSheet = workbook.Sheets['配送業者名推奨値'];
                carrierList = XLSX.utils.sheet_to_json(carrierSheet, { header: 1 });
                
                templateLoaded = true;
                console.log('テンプレートファイル自動読み込み完了');
            } catch (error) {
                console.warn('テンプレートファイルの自動読み込みに失敗しました:', error.message);
            }
        }

        // TXTファイルを読み込む（Amazon注文レポート）
        async function handleTxtUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            document.getElementById('file-name').textContent = file.name;

            try {
                const fileContent = await file.text();
                const result = Papa.parse(fileContent, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: '\t', // TSV形式（タブ区切り）
                    encoding: 'UTF-8'
                });
                
                csvData = result.data;
                console.log('Amazon注文レポート読み込み完了:', csvData.length, '件');
                
                // 処理ボタンを有効化
                document.getElementById('process-btn').disabled = false;
            } catch (error) {
                alert('TXTファイルの読み込みに失敗しました: ' + error.message);
            }
        }

        // データを処理して出荷通知ファイルを生成
        function processData() {
            if (csvData.length === 0) {
                alert('TXTファイルを先に読み込んでください');
                return;
            }

            const processed = csvData.map(row => {
                // Amazon注文レポートの標準フィールドから抽出
                const orderNumber = row['order-id'] || '';
                const shipDate = extractShipDate(row);
                const carrierInfo = row['ssa-carrier'] || 'ヤマト運輸';
                const trackingNumber = extractTrackingNumber(row);

                return {
                    'order-id': orderNumber,
                    'order-item-id': row['order-item-id'] || '',
                    'quantity': row['quantity-purchased'] || '',
                    'ship-date': formatShipDate(shipDate),
                    'carrier-code': getCarrierCode(carrierInfo),
                    'carrier-name': getCarrierName(carrierInfo),
                    'tracking-number': trackingNumber,
                    'ship-method': '',
                    'cod-collection-method': '',
                    'transparency_code': '',
                    'ship_from_address_name': '',
                    'ship_from_address_line1': '',
                    'ship_from_address_line2': '',
                    'ship_from_address_line3': '',
                    'ship_from_address_city': '',
                    'ship_from_address_county': '',
                    'ship_from_address_state_or_region': '',
                    'ship_from_address_postalcode': '',
                    'ship_from_address_countrycode': ''
                };
            });

            processedData = processed;
            displayPreview(processed);
            
            // ダウンロードボタンを有効化
            document.getElementById('download-btn').disabled = false;
        }

        // 注文番号を抽出（Amazon標準フィールド）
        function extractOrderNumber(row) {
            return row['order-id'] || '';
        }

        // 出荷日を抽出（今日の日付をデフォルトに）
        function extractShipDate(row) {
            // 出荷日は手動入力が必要なため、今日の日付を使用
            return new Date().toISOString().split('T')[0];
        }

        // 配送業者情報を抽出
        function extractCarrierInfo(row) {
            return row['ssa-carrier'] || 'ヤマト運輸';
        }

        // 追跡番号を抽出（手動入力が必要）
        function extractTrackingNumber(row) {
            // 追跡番号は通常手動入力が必要
            return '';
        }

        // 出荷日をフォーマット
        function formatShipDate(dateStr) {
            if (!dateStr) return new Date().toISOString().split('T')[0];
            
            // 既にYYYY-MM-DD形式の場合はそのまま返す
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // その他の形式は今日の日付を使用
            return new Date().toISOString().split('T')[0];
        }

        // 配送業者コードを取得
        function getCarrierCode(carrierInfo) {
            if (!carrierInfo) return 'YAMATO';
            
            if (carrierInfo.includes('ヤマト') || carrierInfo.includes('YAMATO')) return 'YAMATO';
            if (carrierInfo.includes('佐川') || carrierInfo.includes('SAGAWA')) return 'SAGAWA';
            if (carrierInfo.includes('郵便') || carrierInfo.includes('Japan Post')) return 'Japan Post';
            if (carrierInfo.includes('フェデックス') || carrierInfo.includes('FEDEX')) return 'FEDEX';
            
            return 'YAMATO'; // デフォルト
        }

        // 配送業者名を取得
        function getCarrierName(carrierInfo) {
            if (!carrierInfo) return 'ヤマト運輸';
            
            if (carrierInfo.includes('ヤマト') || carrierInfo.includes('YAMATO')) return 'ヤマト運輸';
            if (carrierInfo.includes('佐川') || carrierInfo.includes('SAGAWA')) return '佐川急便';
            if (carrierInfo.includes('郵便') || carrierInfo.includes('Japan Post')) return '日本郵便';
            if (carrierInfo.includes('フェデックス') || carrierInfo.includes('FEDEX')) return 'フェデックス';
            
            return 'ヤマト運輸'; // デフォルト
        }

        // プレビューを表示
        function displayPreview(data) {
            const previewSection = document.getElementById('preview-section');
            const tbody = document.getElementById('preview-tbody');
            const moreRows = document.getElementById('more-rows');
            
            // テーブルクリア
            tbody.innerHTML = '';
            
            // 最初の5行を表示
            const displayData = data.slice(0, 5);
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-t';
                tr.innerHTML = `
                    <td class="px-3 py-2">${row['order-id']}</td>
                    <td class="px-3 py-2">${row['ship-date']}</td>
                    <td class="px-3 py-2">${row['carrier-code']}</td>
                    <td class="px-3 py-2">${row['carrier-name']}</td>
                    <td class="px-3 py-2">${row['tracking-number']}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // 残り行数表示
            if (data.length > 5) {
                moreRows.textContent = `他 ${data.length - 5} 行...`;
                moreRows.style.display = 'block';
            } else {
                moreRows.style.display = 'none';
            }
            
            previewSection.style.display = 'block';
        }

        // TXTファイルをダウンロード
        function downloadTxt() {
            if (processedData.length === 0) {
                alert('データを先に処理してください');
                return;
            }

            // ヘッダー行を作成
            const headers = [
                'TemplateType=OrderFulfillment',
                'Version=2011.1102',
                'この行はAmazonが使用しますので変更や削除しないでください。'
            ];

            const columnHeaders = [
                '注文番号', '注文商品番号', '出荷数', '出荷日', '配送業者コード', '配送業者名',
                'お問い合わせ伝票番号', '配送方法', '代金引換', '製品が透明に登録されている場合の製品の透明コード。',
                '出荷元住所-名称', '出荷元住所-行 1', '出荷元住所-行 2', '出荷元住所-行 3',
                '出荷元住所-市町村', '出荷元住所-郡', '出荷元住所-州・省', '出荷元住所-郵便番号',
                '出荷元住所-国コード'
            ];

            const columnIds = [
                'order-id', 'order-item-id', 'quantity', 'ship-date', 'carrier-code', 'carrier-name',
                'tracking-number', 'ship-method', 'cod-collection-method', 'transparency_code',
                'ship_from_address_name', 'ship_from_address_line1', 'ship_from_address_line2',
                'ship_from_address_line3', 'ship_from_address_city', 'ship_from_address_county',
                'ship_from_address_state_or_region', 'ship_from_address_postalcode', 'ship_from_address_countrycode'
            ];

            // データ行を作成
            const dataRows = processedData.map(row => 
                columnIds.map(id => row[id] || '').join('\t')
            );

            // 全ての行を結合
            const content = [
                headers.join('\t'),
                columnHeaders.join('\t'),
                columnIds.join('\t'),
                ...dataRows
            ].join('\n');

            // ファイルをダウンロード
            const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shipping_notification_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
