<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amazon出荷通知処理システム</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50 p-6">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-900 mb-8">
            Amazon出荷通知処理システム
        </h1>

        <div class="space-y-6">
            <!-- ファイルアップロード -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4">ファイル読み込み</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            注文レポートファイル
                        </label>
                        <input
                            type="file"
                            id="txt-upload"
                            class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none"
                        />
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            追跡番号ファイル
                        </label>
                        <input
                            type="file"
                            id="csv-upload"
                            accept=".csv"
                            class="block w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 focus:outline-none"
                        />
                    </div>
                </div>
            </div>

            <!-- 処理ボタン -->
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4">データ処理</h2>
                
                <div class="flex space-x-4">
                    <button
                        id="process-btn"
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled
                    >
                        データ処理実行
                    </button>
                    
                    <button
                        id="download-btn"
                        class="px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                        disabled
                    >
                        TXTファイルダウンロード
                    </button>
                </div>
            </div>

            <!-- プレビュー -->
            <div id="preview-section" class="bg-white p-6 rounded-lg shadow" style="display: none;">
                <h2 class="text-lg font-semibold mb-4">処理結果プレビュー</h2>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-3 py-2 text-left">注文番号</th>
                                <th class="px-3 py-2 text-left">出荷日</th>
                                <th class="px-3 py-2 text-left">配送業者コード</th>
                                <th class="px-3 py-2 text-left">配送業者名</th>
                                <th class="px-3 py-2 text-left">追跡番号</th>
                            </tr>
                        </thead>
                        <tbody id="preview-tbody">
                        </tbody>
                    </table>
                    <p id="more-rows" class="text-gray-500 text-sm mt-2" style="display: none;"></p>
                </div>
            </div>

            <!-- 注意事項 -->
            <div class="bg-yellow-50 p-6 rounded-lg border border-yellow-200">
                <h3 class="text-lg font-semibold text-yellow-800 mb-2">注意事項</h3>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>• Amazonセラーセントラルからダウンロードした注文レポートCSVをそのまま使用してください</li>
                    <li>• 出荷日・配送業者・追跡番号の情報を手動で入力する場合は、適切な形式で入力してください</li>
                    <li>• 生成されたTXTファイルをAmazonセラーセントラルの「注文関連ファイルをアップロード」にアップロードしてください</li>
                    <li>• テンプレートファイルは自動で読み込まれます</li>
                </ul>
            </div>
        </div>
    </div>

    <script>
        // グローバル変数
        let amazonOrderData = [];
        let trackingData = [];
        let templateData = [];
        let carrierList = [];
        let processedData = [];
        let templateLoaded = false;

        // キャリアコードマッピング
        const carrierCodeMap = {
            'ヤマト運輸': 'YAMATO',
            'YAMATO': 'YAMATO',
            '日本郵便': 'Japan Post',
            'Japan Post': 'Japan Post',
            '佐川急便': 'SAGAWA',
            'SAGAWA': 'SAGAWA',
            'フェデックス': 'FEDEX',
            'FEDEX': 'FEDEX'
        };

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - 初期化開始');
            
            loadTemplateFile();
            
            // 直接イベントリスナーを設定
            const txtUpload = document.getElementById('txt-upload');
            const csvUpload = document.getElementById('csv-upload');
            const processBtn = document.getElementById('process-btn');
            const downloadBtn = document.getElementById('download-btn');
            
            console.log('要素確認:', {
                txtUpload: !!txtUpload,
                csvUpload: !!csvUpload,
                processBtn: !!processBtn,
                downloadBtn: !!downloadBtn
            });
            
            if (txtUpload) {
                txtUpload.addEventListener('change', handleTxtUpload);
                console.log('TXTアップロードイベント設定完了');
            }
            
            if (csvUpload) {
                csvUpload.addEventListener('change', handleCsvUpload);
                console.log('CSVアップロードイベント設定完了');
            }
            
            if (processBtn) {
                processBtn.addEventListener('click', processData);
                console.log('処理ボタンイベント設定完了');
            }
            
            if (downloadBtn) {
                downloadBtn.addEventListener('click', downloadTxt);
                console.log('ダウンロードボタンイベント設定完了');
            }
            
            console.log('初期化完了');
        });

        // イベントリスナー設定
        function setupEventListeners() {
            document.getElementById('txt-upload').addEventListener('change', handleTxtUpload);
            document.getElementById('process-btn').addEventListener('click', processData);
            document.getElementById('download-btn').addEventListener('click', downloadTxt);
        }

        // テンプレートファイルを自動読み込み
        async function loadTemplateFile() {
            try {
                const response = await fetch('./Flat.File.ShippingConfirmation.jp.xls');
                if (!response.ok) {
                    console.warn('テンプレートファイルが見つかりません');
                    return;
                }
                
                const fileContent = await response.arrayBuffer();
                const workbook = XLSX.read(fileContent, { type: 'array' });
                
                // テンプレートシートのヘッダー取得
                const templateSheet = workbook.Sheets['出荷通知テンプレート_Template'];
                templateData = XLSX.utils.sheet_to_json(templateSheet, { header: 1 });
                
                // 配送業者リスト取得
                const carrierSheet = workbook.Sheets['配送業者名推奨値'];
                carrierList = XLSX.utils.sheet_to_json(carrierSheet, { header: 1 });
                
                templateLoaded = true;
                console.log('テンプレートファイル自動読み込み完了');
            } catch (error) {
                console.warn('テンプレートファイルの自動読み込みに失敗しました:', error.message);
            }
        }

        // Amazon注文レポートファイルを読み込む
        async function handleTxtUpload(event) {
            console.log('TXT upload triggered');
            const file = event.target.files[0];
            console.log('TXT file selected:', file ? file.name : 'none');
            
            if (!file) return;

            try {
                const fileContent = await file.text();
                const result = Papa.parse(fileContent, {
                    header: true,
                    skipEmptyLines: true,
                    delimiter: '\t',
                    encoding: 'UTF-8'
                });
                
                amazonOrderData = result.data;
                console.log('注文レポートファイル読み込み完了:', amazonOrderData.length, '件');
                
                checkProcessButtonState();
            } catch (error) {
                console.error('TXT読み込みエラー:', error);
                alert('注文レポートファイルの読み込みに失敗しました: ' + error.message);
            }
        }

        // 追跡番号ファイルを読み込む
        async function handleCsvUpload(event) {
            console.log('CSV upload triggered');
            const file = event.target.files[0];
            console.log('CSV file selected:', file ? file.name : 'none');
            
            if (!file) return;

            try {
                const arrayBuffer = await file.arrayBuffer();
                const decoder = new TextDecoder('shift_jis');
                const fileContent = decoder.decode(arrayBuffer);
                
                const result = Papa.parse(fileContent, {
                    header: false,
                    skipEmptyLines: true,
                    delimiter: ',',
                    encoding: 'shift_jis'
                });
                
                trackingData = result.data;
                console.log('追跡番号ファイル読み込み完了:', trackingData.length, '件');
                
                checkProcessButtonState();
            } catch (error) {
                console.error('CSV読み込みエラー:', error);
                alert('追跡番号ファイルの読み込みに失敗しました: ' + error.message);
            }
        }

        // 処理ボタンの状態をチェック
        function checkProcessButtonState() {
            const processBtn = document.getElementById('process-btn');
            const hasOrderData = amazonOrderData.length > 0;
            const hasTrackingData = trackingData.length > 0;
            
            console.log('Check button state:', {
                hasOrderData,
                hasTrackingData,
                orderCount: amazonOrderData.length,
                trackingCount: trackingData.length
            });
            
            processBtn.disabled = !(hasOrderData && hasTrackingData);
            
            if (hasOrderData && hasTrackingData) {
                console.log('両ファイル読み込み完了 - ボタン有効化');
            }
        }

        // データを処理して出荷通知ファイルを生成
        function processData() {
            if (amazonOrderData.length === 0) {
                alert('注文レポートファイルを先に読み込んでください');
                return;
            }

            if (trackingData.length === 0) {
                alert('追跡番号ファイルを先に読み込んでください');
                return;
            }

            // 追跡番号マップを作成
            const trackingMap = buildTrackingMap();
            
            let unmatchedCount = 0;
            const processed = amazonOrderData.map(order => {
                const matchResult = findTrackingNumber(order, trackingMap);
                
                if (!matchResult) {
                    unmatchedCount++;
                }

                return {
                    'order-id': order['order-id'] || '',
                    'order-item-id': order['order-item-id'] || '',
                    'quantity': order['quantity-purchased'] || '',
                    'ship-date': formatShipDate(new Date().toISOString().split('T')[0]),
                    'carrier-code': getCarrierCode(order['ssa-carrier']),
                    'carrier-name': getCarrierName(order['ssa-carrier']),
                    'tracking-number': matchResult ? matchResult.trackingNumber : '',
                    'ship-method': '',
                    'cod-collection-method': '',
                    'transparency_code': '',
                    'ship_from_address_name': '',
                    'ship_from_address_line1': '',
                    'ship_from_address_line2': '',
                    'ship_from_address_line3': '',
                    'ship_from_address_city': '',
                    'ship_from_address_county': '',
                    'ship_from_address_state_or_region': '',
                    'ship_from_address_postalcode': '',
                    'ship_from_address_countrycode': ''
                };
            });

            processedData = processed;
            
            // 未マッチの警告表示
            if (unmatchedCount > 0) {
                alert(`⚠️ ${unmatchedCount}件の注文で追跡番号が見つかりませんでした。\n手動で追跡番号を入力するか、追跡番号CSVを確認してください。`);
            }
            
            displayPreview(processed);
            
            // ダウンロードボタンを有効化
            document.getElementById('download-btn').disabled = false;
        }

        // 追跡番号マップを構築
        function buildTrackingMap() {
            const phoneMap = {};
            const nameAddressMap = {};
            
            trackingData.forEach(row => {
                const trackingNumber = row[3]; // D列：追跡番号
                const phone = row[8]; // I列：電話番号
                const address1 = row[11] || ''; // L列：住所1
                const address2 = row[12] || ''; // M列：住所2
                const name = row[15] || ''; // P列：名前
                
                // 電話番号マップ
                if (phone && phone !== '0' && trackingNumber) {
                    const normalizedPhone = normalizePhone(phone);
                    if (normalizedPhone) {
                        phoneMap[normalizedPhone] = trackingNumber;
                    }
                }
                
                // 名前+住所マップ
                if (name && (address1 || address2) && trackingNumber) {
                    const fullAddress = normalizeAddress(address1 + address2);
                    const nameAddressKey = `${name.trim()}|${fullAddress}`;
                    nameAddressMap[nameAddressKey] = trackingNumber;
                }
            });
            
            return { phoneMap, nameAddressMap };
        }

        // 追跡番号を検索
        function findTrackingNumber(order, trackingMap) {
            // 1. 電話番号マッチング（優先）
            const phone = normalizePhone(order['ship-phone-number']);
            if (phone && trackingMap.phoneMap[phone]) {
                return {
                    trackingNumber: trackingMap.phoneMap[phone],
                    matchType: 'phone'
                };
            }
            
            // 2. 名前+住所マッチング
            const name = (order['recipient-name'] || '').trim();
            const address = normalizeAddress(
                (order['ship-address-1'] || '') + 
                (order['ship-address-2'] || '') + 
                (order['ship-city'] || '')
            );
            
            if (name && address) {
                const nameAddressKey = `${name}|${address}`;
                if (trackingMap.nameAddressMap[nameAddressKey]) {
                    return {
                        trackingNumber: trackingMap.nameAddressMap[nameAddressKey],
                        matchType: 'name-address'
                    };
                }
                
                // 3. あいまい一致
                return fuzzyMatch(name, address, trackingMap.nameAddressMap);
            }
            
            return null;
        }

        // 電話番号正規化
        function normalizePhone(phone) {
            if (!phone || phone === '0') return null;
            
            // ハイフン・スペース削除
            let normalized = phone.replace(/[-\s]/g, '');
            
            // 先頭0補完
            if (normalized.length === 10 && !normalized.startsWith('0')) {
                normalized = '0' + normalized;
            }
            
            return normalized.length === 11 ? normalized : null;
        }

        // 住所正規化
        function normalizeAddress(address) {
            return address
                .replace(/\s+/g, '') // 空白除去
                .replace(/[０-９]/g, (s) => // 全角数字→半角
                    String.fromCharCode(s.charCodeAt(0) - 0xFEE0))
                .toLowerCase();
        }

        // あいまいマッチング
        function fuzzyMatch(targetName, targetAddress, nameAddressMap) {
            let bestMatch = null;
            let bestScore = 0;
            
            for (const [key, trackingNumber] of Object.entries(nameAddressMap)) {
                const [name, address] = key.split('|');
                const nameScore = calculateSimilarity(targetName, name);
                const addressScore = calculateSimilarity(targetAddress, address);
                const totalScore = (nameScore + addressScore) / 2;
                
                if (totalScore > 0.8 && totalScore > bestScore) {
                    bestMatch = trackingNumber;
                    bestScore = totalScore;
                }
            }
            
            return bestMatch ? {
                trackingNumber: bestMatch,
                matchType: 'fuzzy'
            } : null;
        }

        // 文字列類似度計算（簡易版）
        function calculateSimilarity(str1, str2) {
            if (str1 === str2) return 1;
            if (!str1 || !str2) return 0;
            
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            
            if (longer.length === 0) return 1;
            
            const distance = levenshteinDistance(longer, shorter);
            return (longer.length - distance) / longer.length;
        }

        // レーベンシュタイン距離
        function levenshteinDistance(str1, str2) {
            const matrix = [];
            
            for (let i = 0; i <= str2.length; i++) {
                matrix[i] = [i];
            }
            
            for (let j = 0; j <= str1.length; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            
            return matrix[str2.length][str1.length];
        }

        // 出荷日をフォーマット
        function formatShipDate(dateStr) {
            if (!dateStr) return new Date().toISOString().split('T')[0];
            
            // 既にYYYY-MM-DD形式の場合はそのまま返す
            if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // その他の形式は今日の日付を使用
            return new Date().toISOString().split('T')[0];
        }

        // 配送業者コードを取得
        function getCarrierCode(carrierInfo) {
            if (!carrierInfo) return 'YAMATO';
            
            if (carrierInfo.includes('ヤマト') || carrierInfo.includes('YAMATO')) return 'YAMATO';
            if (carrierInfo.includes('佐川') || carrierInfo.includes('SAGAWA')) return 'SAGAWA';
            if (carrierInfo.includes('郵便') || carrierInfo.includes('Japan Post')) return 'Japan Post';
            if (carrierInfo.includes('フェデックス') || carrierInfo.includes('FEDEX')) return 'FEDEX';
            
            return 'YAMATO'; // デフォルト
        }

        // 配送業者名を取得
        function getCarrierName(carrierInfo) {
            if (!carrierInfo) return 'ヤマト運輸';
            
            if (carrierInfo.includes('ヤマト') || carrierInfo.includes('YAMATO')) return 'ヤマト運輸';
            if (carrierInfo.includes('佐川') || carrierInfo.includes('SAGAWA')) return '佐川急便';
            if (carrierInfo.includes('郵便') || carrierInfo.includes('Japan Post')) return '日本郵便';
            if (carrierInfo.includes('フェデックス') || carrierInfo.includes('FEDEX')) return 'フェデックス';
            
            return 'ヤマト運輸'; // デフォルト
        }

        // プレビューを表示
        function displayPreview(data) {
            const previewSection = document.getElementById('preview-section');
            const tbody = document.getElementById('preview-tbody');
            const moreRows = document.getElementById('more-rows');
            
            // テーブルクリア
            tbody.innerHTML = '';
            
            // 最初の5行を表示
            const displayData = data.slice(0, 5);
            displayData.forEach(row => {
                const tr = document.createElement('tr');
                tr.className = 'border-t';
                tr.innerHTML = `
                    <td class="px-3 py-2">${row['order-id']}</td>
                    <td class="px-3 py-2">${row['ship-date']}</td>
                    <td class="px-3 py-2">${row['carrier-code']}</td>
                    <td class="px-3 py-2">${row['carrier-name']}</td>
                    <td class="px-3 py-2">${row['tracking-number']}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // 残り行数表示
            if (data.length > 5) {
                moreRows.textContent = `他 ${data.length - 5} 行...`;
                moreRows.style.display = 'block';
            } else {
                moreRows.style.display = 'none';
            }
            
            previewSection.style.display = 'block';
        }

        // TXTファイルをダウンロード
        function downloadTxt() {
            if (processedData.length === 0) {
                alert('データを先に処理してください');
                return;
            }

            // ヘッダー行を作成
            const headers = [
                'TemplateType=OrderFulfillment',
                'Version=2011.1102',
                'この行はAmazonが使用しますので変更や削除しないでください。'
            ];

            const columnHeaders = [
                '注文番号', '注文商品番号', '出荷数', '出荷日', '配送業者コード', '配送業者名',
                'お問い合わせ伝票番号', '配送方法', '代金引換', '製品が透明に登録されている場合の製品の透明コード。',
                '出荷元住所-名称', '出荷元住所-行 1', '出荷元住所-行 2', '出荷元住所-行 3',
                '出荷元住所-市町村', '出荷元住所-郡', '出荷元住所-州・省', '出荷元住所-郵便番号',
                '出荷元住所-国コード'
            ];

            const columnIds = [
                'order-id', 'order-item-id', 'quantity', 'ship-date', 'carrier-code', 'carrier-name',
                'tracking-number', 'ship-method', 'cod-collection-method', 'transparency_code',
                'ship_from_address_name', 'ship_from_address_line1', 'ship_from_address_line2',
                'ship_from_address_line3', 'ship_from_address_city', 'ship_from_address_county',
                'ship_from_address_state_or_region', 'ship_from_address_postalcode', 'ship_from_address_countrycode'
            ];

            // データ行を作成
            const dataRows = processedData.map(row => 
                columnIds.map(id => row[id] || '').join('\t')
            );

            // 全ての行を結合
            const content = [
                headers.join('\t'),
                columnHeaders.join('\t'),
                columnIds.join('\t'),
                ...dataRows
            ].join('\n');

            // ファイルをダウンロード
            const blob = new Blob([content], { type: 'text/plain; charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `shipping_notification_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>
